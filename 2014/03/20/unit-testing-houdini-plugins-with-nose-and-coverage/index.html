<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Unit testing Houdini Python plugins with nose and coverage - Unlogic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <link rel="canonical" href="http://unlogic.co.uk/2014/03/20/unit-testing-houdini-plugins-with-nose-and-coverage/">

  
  

  
  

  
  

  <link rel="stylesheet" type="text/css" href="http://unlogic.co.uk//css/combined-min.css">

</head>
<body class="">

<div class="site-wrap">
  <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://unlogic.co.uk/" class="site-title">Unlogic</a>
      <nav class="site-nav right">
      <a href="http://unlogic.co.uk/about/">About</a>
<a href="http://unlogic.co.uk/tags">Tags</a>
<a href="http://unlogic.co.uk/contact/">Contact</a>

</form>

      </nav>
      <div class="clearfix"></div>
    </div>
  </div>
</header>

  <div class="post p2 p-responsive wrap" role="main">
    <div class="measure">
      <div class="post-header mb2">
        <h1 class="py2">Unit testing Houdini Python plugins with nose and coverage</h1>
        <span class="post-meta">Mar 20, 2014 by </span><br>
        
      </div>

      <article class="post-content">
      <p>We all know how important unit testing is, right? But often you wonder how can
you test a not so straight forward tool. In this case we&rsquo;re talking about a
Python script intended to run inside <a href="http://sidefx.com">Houdini</a>. In my specific
case the python script is launched from a script on a node when the user clicks
a button on the OTL. I want to run unit tests on this script, but the problem is
that the script parses a set of nodes and does various things according to the
types of nodes and layout of the nodes. It&rsquo;s clear that the HOM is required in the
unit tests. So I need to somehow run my unit tests inside houdini and have
some nodes available for my testing. Fortunately this isn&rsquo;t difficult to do, but
it does require a little setup and some fiddling in order to get it to work.</p>

<p>I&rsquo;ll be using <a href="https://nose.readthedocs.org">nose tests</a> as my test runner and
<a href="http://nedbatchelder.com/code/coverage/">coverage</a> for coverage testing.
Because I want to make sure I test as much code as possible. I created a hip file that
contains whatever nodes and connections I need to run most of the tests and saved
this to the same directory as my test script.</p>

<p>Before we write some code you will need to install <code>nose</code> and <code>coverage</code> and make
sure they work.</p>

<p>Now that we have all our dependencies installed, we need to import all the
modules we need and set some things up.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">nose</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;../path_of_module&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;NOSE_WITH_COVERAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;1&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;NOSE_COVER_PACKAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;module_to_test&#39;</span>

<span class="kn">import</span> <span class="nn">hou</span>

<span class="kn">import</span> <span class="nn">module_to_test</span>
</code></pre></div>


<p>We import the <code>nose</code> module and then we need to tell nose to make use of the
coverage package. <code>os.environ['NOSE_WITH_COVERAGE'] = '1'</code> does just that, and
<code>os.environ['NOSE_COVER_PACKAGE'] = 'module_to_test'</code> restricts our test results to
the module(s) we want to test. If you want to specify multiple modules simply
separate them with commas: <code>os.environ['NOSE_COVER_PACKAGE'] = 'module_to_test,another_module'</code></p>

<p>Unfortunately for this to work properly you need to patch nose&rsquo;s cover plugin.
There&rsquo;s a small bug in older versions, so depending on your distro you may need to
make the following change to
<code>nose/plugins/cover.py</code></p>

<p>Change these lines
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">pkgs</span> <span class="ow">in</span> <span class="p">[</span><span class="n">tolist</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">cover_packages</span><span class="p">]:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">coverPackages</span><span class="o">.</span><span class="n">extends</span><span class="p">(</span><span class="n">pkgs</span><span class="p">)</span>
</code></pre></div>
</p>

<p>to these lines
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">pkgs</span> <span class="ow">in</span> <span class="n">tolist</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">cover_packages</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">coverPackages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pkgs</span><span class="p">)</span>
</code></pre></div>
</p>

<p>Otherwise the <code>NOSE_COVER_PACKAGE</code> variable won&rsquo;t work properly.</p>

<p>I also setup the <code>sys.path</code> so that I load my local module rather
than the globally installed one. Depending on how your directories are laid out
you might not need this.</p>

<p>After this we need to import the <code>hou</code> module and finally the module(s) we want to test.</p>

<p>Then we write our main function which will load our hip file and start our tests</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">hou</span><span class="o">.</span><span class="n">hipFile</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;/path/to/test.hip&#39;</span><span class="p">)</span>

    <span class="n">nose</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="p">[</span><span class="n">__file__</span><span class="p">],</span> <span class="s">&#39;--cover_html&#39;</span><span class="p">])</span>
</code></pre></div>
</p>

<p>As you can see, you can pass the commandline argments for nose into the run function.
With <code>--cover_html</code> we automatically generate the html coverage information. You
could omit this and run <code>coverage html</code> after the tests complete to generate the
html coverage pages instead. The output from the two methods is slightly different,
so pick the one that you prefer.</p>

<p>The next bits are up to you now, here you write your tests following a format like</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_afunction</span><span class="p">():</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">hou</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s">&#39;/obj/geo/box1&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">module_to_test</span><span class="o">.</span><span class="n">do_stuff</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
</code></pre></div>
</p>

<p>You can access any and all <code>hou.</code> calls from your tests, so do what you must.</p>

<p>Once you are happy with your tests, or you just want to go ahead and test a single
one, we need to run the tests through hython. Bear in mind that you&rsquo;ll consume a
batch license when you run these tests.</p>

<p><div class="highlight"><pre><code class="language-bash" data-lang="bash">hython ./test.py
</code></pre></div>
</p>

<p>where <code>test.py</code> is the name of the file that contains the tests you wrote.
After a while you&rsquo;ll see your tests run and the coverage output. It should
look a little like this</p>

<p><div class="highlight"><pre><code class="language-bash" data-lang="bash">...
Name          Stmts   Miss  Cover   Missing
-------------------------------------------
module_to_test  <span class="m">25</span>     <span class="m">14</span>    44%   1-2, 6, 9, 12-15, 21, 27-32
another_module  <span class="m">314</span>    <span class="m">173</span>    45%   4-20, 24, 37-38, 46
-------------------------------------------
TOTAL           <span class="m">339</span>    <span class="m">187</span>    45%   
----------------------------------------------------------------------
Ran <span class="m">3</span> tests in 0.053s

OK
</code></pre></div>
</p>

<p>You&rsquo;ll also have a directory called <code>cover</code> which will contain the html output,
assuming you have the <code>--cover_html</code> flag on. If not, run <code>coverage html</code> and
after a short wait you will have a <code>htmlcov</code> directory with the html coverage
info.</p>

<p>I hope this helps you out if you ever wanted to unit test your Houdini Python
script. It&rsquo;s not as difficult as I thought, but it does take a little bit of setting
up to get everything to work right. There will still be some limitations as to what
you can test and get results for, but any testing is always better than none at
all I say.</p>

<p>And the <code>test.py</code> file as a whole</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">nose</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;../path_of_module&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;NOSE_WITH_COVERAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;1&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;NOSE_COVER_PACKAGE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;module_to_test&#39;</span>

<span class="kn">import</span> <span class="nn">hou</span>

<span class="kn">import</span> <span class="nn">module_to_test</span>


<span class="k">def</span> <span class="nf">test_afunction</span><span class="p">():</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">hou</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="s">&#39;/obj/geo/box1&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">module_to_test</span><span class="o">.</span><span class="n">do_stuff</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">hou</span><span class="o">.</span><span class="n">hipFile</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s">&#39;/path/to/test.hip&#39;</span><span class="p">)</span>

    <span class="n">nose</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="p">[</span><span class="n">__file__</span><span class="p">],</span> <span class="s">&#39;--cover_html&#39;</span><span class="p">])</span>
</code></pre></div>
</p>

      </article>

      <p class="post-meta">Tags:&nbsp;
        
            
            <a href="http://unlogic.co.uk//tags/houdini">houdini</a>
        
            ,&nbsp;
            <a href="http://unlogic.co.uk//tags/unittest">unittest</a>
        
            ,&nbsp;
            <a href="http://unlogic.co.uk//tags/nose">nose</a>
        
            ,&nbsp;
            <a href="http://unlogic.co.uk//tags/coverage">coverage</a>
        
            ,&nbsp;
            <a href="http://unlogic.co.uk//tags/python">python</a>
        
      </p>

      
<div id="disqus_thread">
  <script type="text/javascript">
     var disqus_shortname = "unlogic";
     var disqus_identifier = "\/2014\/03\/20\/unit-testing-houdini-plugins-with-nose-and-coverage\/";

     (function() {
       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
       dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
</div>


    </div>
  </div>
</div>
    <footer class="footer">
      <div class="p2 wrap">
        <div class="measure mt1 center">
      <nav class="social-icons icons">
<a class="fa fa-rss rss" href="http://unlogic.co.uk/index.xml"></a>

<a class="fa fa-twitter twitter" href="https://twitter.com/binaryheadache"></a>

</nav>

          <small>
            Copyright &#169; 2015<br>
            Powered by <a href="http://gohugo.io/" target="_blank">Hugo</a> &amp; <a href="https://github.com/azmelanar/hugo-theme-pixyll" target="_blank">Pixyll</a>
          </small>
        </div>
      </div>
    </footer>

    
    <script src="http://unlogic.co.uk/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    


</body>
</html>

