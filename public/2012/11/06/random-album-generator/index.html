<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Random album generator in python - Unlogic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <link rel="canonical" href="http://unlogic.co.uk/2012/11/06/random-album-generator/">

  
  

  
  

  
  

  <link rel="stylesheet" type="text/css" href="http://unlogic.co.uk//css/combined-min.css">

</head>
<body class="">

<div class="site-wrap">
  <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://unlogic.co.uk/" class="site-title">Unlogic</a>
      <nav class="site-nav right">
      <a href="http://unlogic.co.uk/tags">Tags</a>

</form>

      </nav>
      <div class="clearfix"></div>
    </div>
  </div>
</header>

  <div class="post p2 p-responsive wrap" role="main">
    <div class="measure">
      <div class="post-header mb2">
        <h1 class="py2">Random album generator in python</h1>
        <span class="post-meta">Nov 6, 2012 by </span><br>
        
      </div>

      <article class="post-content">
      <p>You may have heard about the &ldquo;random music album&rdquo; thing. Basically it goes like this:</p>

<ul>
<li>The album cover is the 4th image from a random page of Flickr&rsquo;s interesting pics</li>
<li>The band name is the title of a random Wikipedia article</li>
<li>The album name comes from the last 3 or 5 words of a famous quote</li>
</ul>

<p>This is all well and good, but isn&rsquo;t getting all this data manually, and then making the album cover a bit tedious? Sure it is, so let&rsquo;s see how we can do this in python</p>

<p>Here are some example images generated with this script (click for the full size picture):</p>


<figure >
    
        <img src="http://unlogic.co.uk/images/content/album2.jpg" />
    
    
</figure>



<figure >
    
        <img src="http://unlogic.co.uk/images/content/album3.jpg" />
    
    
</figure>



<figure >
    
        <img src="http://unlogic.co.uk/images/content/album4.jpg" />
    
    
</figure>


<p>Let&rsquo;s cover our dependencies first. You will need:</p>

<ul>
<li>python 2.6 (or similar)</li>
<li>PIL (<a href="http://www.pythonware.com/products/pil/">python Image Library</a>)</li>
<li>A <a href="http://www.flickr.com/services/apps/create/apply/">Flickr API key</a></li>
<li><a href="http://www.gnu.org/software/wget/">wget</a></li>
</ul>

<p>Not much to ask for is it? So once you&rsquo;ve made sure you have all that, let&rsquo;s start by getting the album cover. This is handled by the <a href="http://www.flickr.com/services/api/flickr.interestingness.getList.html">interestingness</a> part of the API and is a very simple call that will return an XML structure of the photos on that page. Once we have a response we parse the XML and get the elements we need to construct the photo URL. It&rsquo;s a short function and here it is:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">getAlbumImage</span><span class="p">():</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;http://api.flickr.com/services/rest/?method=flickr.interestingness.getList&amp;api_key=YOURAPIKEYHERE&amp;per_page=6&amp;page=</span><span class="si">%d</span><span class="s">&amp;format=rest&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">dom</span> <span class="o">=</span> <span class="n">minidom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>

    <span class="n">elem</span> <span class="o">=</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">&#39;photo&#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">farm_id</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">getAttributeNode</span><span class="p">(</span><span class="s">&#39;farm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nodeValue</span>
    <span class="n">server_id</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">getAttributeNode</span><span class="p">(</span><span class="s">&#39;server&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nodeValue</span>
    <span class="n">the_id</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">getAttributeNode</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nodeValue</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">getAttributeNode</span><span class="p">(</span><span class="s">&#39;secret&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nodeValue</span>
    
    <span class="n">photo_url</span> <span class="o">=</span> <span class="s">&quot;http://farm</span><span class="si">%s</span><span class="s">.staticflickr.com/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_b.jpg&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">farm_id</span><span class="p">,</span> <span class="n">server_id</span><span class="p">,</span> <span class="n">the_id</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span>
    <span class="n">target_photo</span> <span class="o">=</span> <span class="s">&#39;band.jpg&#39;</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s">&quot;/usr/bin/wget&quot;</span><span class="p">,</span> <span class="s">&quot;-O&quot;</span><span class="p">,</span> <span class="n">target_photo</span><span class="p">,</span> <span class="n">photo_url</span><span class="p">])</span>
</code></pre></div>


<p>First we generate a random number which will be the page number we use in constructing the API URL. Once constructed we use <code>minidom</code> to parse it and start extracting our data. If you paste the URL into your browser (with your valid API key) you can see the response format. Now that we have all the data we need, we construct our image URL (the format for this is in the docs) and save it to <code>band.jpg</code> using <code>wget</code>. You can of course use something else, but this is just easy here.</p>

<p>Right, onto getting our band name. This is the random Wikipedia article. Luckily Wikipedia has an API also, and doesn&rsquo;t require an API key for this purpose. This is an even shorter function:</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">getBandName</span><span class="p">():</span>
    <span class="n">random_wiki_url</span> <span class="o">=</span> <span class="s">&quot;http://en.wikipedia.org/w/api.php?format=xml&amp;action=query&amp;list=random&amp;rnnamespace=0&amp;rnlimit=1&quot;</span>
    <span class="n">dom</span> <span class="o">=</span> <span class="n">minidom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">random_wiki_url</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">&#39;page&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">getAttributeNode</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">nodeValue</span>
</code></pre></div>
</p>

<p>As above we create the URL, parse the output with minidom and fetch our page title. Done.</p>

<p>Album title is a little trickier. I couldn&rsquo;t find a decent quote page that offered a free, easy to use API, so I decided to be a little more hacky and just parse the HTML itself. Hey, it works, don&rsquo;t judge me. We need a helper class for this called <code>MyHTMLParser</code> that derives from python&rsquo;s <a href="http://docs.python.org/2/library/htmlparser.html?highlight=htmlparser#HTMLParser">HTMLParser</a> class.</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">MyHTMLParser</span><span class="p">(</span><span class="n">HTMLParser</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">HTMLParser</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quotes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&quot;dt&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;class&#39;</span> <span class="ow">and</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;quote&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">handle_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quotes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">getAlbumTitle</span><span class="p">():</span>
    <span class="n">random_quote_url</span> <span class="o">=</span> <span class="s">&quot;http://www.quotationspage.com/random.php3&quot;</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">random_quote_url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">MyHTMLParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

    <span class="n">num_quotes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">quotes</span><span class="p">)</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">quotes</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_quotes</span><span class="p">)]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>

    <span class="n">last_set</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">quote</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">last_set</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">):</span>
        <span class="n">last_set</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="o">-</span><span class="n">last_set</span><span class="p">:])</span>
</code></pre></div>
</p>

<p>The class here is used to parse the HTML from <a href="http://www.quotationspage.com/random.php3">http://www.quotationspage.com/random.php3</a>, specifically the tag that starts with <code>quote</code>. Once we have that we start capturing the data between that tag and store it in an array. Our <code>getAlbumTitle</code> function will use this data to select a random quote and then get the last 3 or 5 words from it and join them with spaces before returning that new string.</p>

<p>So now we have the data that we need, we just need to wrap it all up and generate our final image using <code>PIL</code>. Surprise, surprise, this isn&rsquo;t a big deal either.</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">band_name</span> <span class="o">=</span> <span class="n">getBandName</span><span class="p">()</span>
    <span class="n">album_title</span> <span class="o">=</span> <span class="n">getAlbumTitle</span><span class="p">()</span>
    <span class="n">cover</span> <span class="o">=</span> <span class="n">getAlbumImage</span><span class="p">()</span>

    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">ImageFont</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">ImageDraw</span>

    <span class="n">fnt</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="s">&quot;/usr/share/fonts/dejavu/DejaVuSans.ttf&quot;</span><span class="p">,</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">lineWidth</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;band.jpg&quot;</span><span class="p">)</span>
    <span class="n">imagebg</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">&#39;RGBA&#39;</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s">&quot;#000000&quot;</span><span class="p">)</span> <span class="c"># make an entirely black image</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">&#39;L&#39;</span><span class="p">,</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">,</span><span class="s">&quot;#000000&quot;</span><span class="p">)</span>       <span class="c"># make a mask that masks out all</span>
    <span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>                     <span class="c"># setup to draw on the main image</span>
    <span class="n">drawmask</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>                <span class="c"># setup to draw on the mask</span>
    <span class="n">drawmask</span><span class="o">.</span><span class="n">line</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">lineWidth</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lineWidth</span><span class="p">),</span>
                  <span class="n">fill</span><span class="o">=</span><span class="s">&quot;#999999&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>        <span class="c"># draw a line on the mask to allow some bg through</span>
    <span class="n">image</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">imagebg</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>                    <span class="c"># put the (somewhat) transparent bg on the main</span>
    <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">band_name</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">fnt</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s">&quot;#ffffff&quot;</span><span class="p">)</span>      <span class="c"># add some text to the main</span>
    <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span><span class="mi">40</span><span class="p">),</span> <span class="n">album_title</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">fnt</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s">&quot;#ffffff&quot;</span><span class="p">)</span>      <span class="c"># add some text to the main</span>
    <span class="k">del</span> <span class="n">draw</span>
    <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;out.jpg&quot;</span><span class="p">,</span><span class="s">&quot;JPEG&quot;</span><span class="p">,</span><span class="n">quality</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</code></pre></div>
</p>

<p>Let&rsquo;s go over what&rsquo;s happening here. You&rsquo;re welcome to clean it up as an exercise if you wish or think some values (like filenames) etc need configuring. Firstly we call the previously defined functions to fetch our album data and then we start the drawing. I use the <code>DejaVuSans.ttf</code> font for this example, but you can use any font you have, or even use different fonts for the title and band name, to make your cover look a bit more pleasing. Once the image we saved from Flickr is open, we start writing our title and band name on the album cover, and save out the result as a <code>JPEG</code>. The code here is commented so I won&rsquo;t go over the details here.</p>

<p>And that&rsquo;s all there is to it. If you want the the script as a whole file, you can <a href="https://gist.github.com/4025200">get it from this gist</a></p>

      </article>

      <p class="post-meta">Tags:&nbsp;
        
            
            <a href="http://unlogic.co.uk//tags/python">python</a>
        
            ,&nbsp;
            <a href="http://unlogic.co.uk//tags/programming">programming</a>
        
      </p>

      
<div id="disqus_thread">
  <script type="text/javascript">
     var disqus_shortname = "unlogic";
     var disqus_identifier = "\/2012\/11\/06\/random-album-generator\/";

     (function() {
       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
       dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
</div>


    </div>
  </div>
</div>
    <footer class="footer">
      <div class="p2 wrap">
        <div class="measure mt1 center">
      <nav class="social-icons icons">
<a class="fa fa-rss rss" href="http://unlogic.co.uk/index.xml"></a>

<a class="fa fa-twitter twitter" href="https://twitter.com/binaryheadache"></a>

</nav>

          <small>
            Copyright &#169; 2015<br>
            Powered by <a href="http://gohugo.io/" target="_blank">Hugo</a> &amp; <a href="https://github.com/azmelanar/hugo-theme-pixyll" target="_blank">Pixyll</a>
          </small>
        </div>
      </div>
    </footer>

    
    <script src="http://unlogic.co.uk/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    


</body>
</html>

