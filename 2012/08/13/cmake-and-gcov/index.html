<!doctype html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Unlogic</title>
        <meta name="author">
        <meta name="description" content="I have a keyboard, a compiler, and a whole load of luck">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="generator" content="Hugo 0.15" />
          <link href="http://unlogic.co.ukpost/index.xml" rel="alternate" type="application/rss+xml" title="Unlogic" />
          <link href="http://unlogic.co.ukpost/index.xml" rel="feed" type="application/rss+xml" title="Unlogic" />
        <link href='//fonts.googleapis.com/css?family=Roboto:400,300,700|Noto+Serif:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="http://unlogic.co.ukcss/styles.css">
        <link rel="icon" href="http://unlogic.co.ukfavicon.ico">
        <link rel="apple-touch-icon" href="http://unlogic.co.ukapple-touch-icon.png" />
        <link rel="stylesheet" href="http://unlogic.co.ukcss/highlightjs/monokai.css">
        <script src="http://unlogic.co.ukjs/vendor/modernizr-2.8.0.min.js"></script>
        <style>
        .site-header h2 .logo {
        background: url(http://unlogic.co.ukimages/keyboard-feature.jpg) no-repeat 0 0;
        }
        @media (min--moz-device-pixel-ratio: 1.3), (-o-min-device-pixel-ratio: 2.6 / 2), (-webkit-min-device-pixel-ratio: 1.3), (min-device-pixel-ratio: 1.3), (min-resolution: 1.3dppx) {
          .site-header h2 .logo {
            background-image: url(http://unlogic.co.ukimages/keyboard-feature.jpg);
        }}
       .site-header {
         background: #2a373d url(http://unlogic.co.ukimages/keyboard-feature.jpg) no-repeat center center;
         z-index: -1;
         color: #BBB;
         height: 170px;
        }
        </style>
    </head>
    <body>
        
        <header class="site-header">
          <div class="transparent-layer">
              <h2><a style="color: #EEE" href="http://unlogic.co.uk">Unlogic</a></h2>
          </div>
        </header>


<div class="container clearfix">
    <main role="main" class="content">
        <article class="post">
            <a class="btn" href="http://unlogic.co.uk" title="">&laquo; </a>
            
<h1><a href="http://unlogic.co.uk/2012/08/13/cmake-and-gcov/" title="cmake and gcov">cmake and gcov</a></h1>

<footer class="post-info"> <span class="post-meta"><time datetime="2012.08.13">2012.08.13</time>
&middot; 
    
    <a href="http://unlogic.co.uktags/cmake">cmake</a>, 
    
    <a href="http://unlogic.co.uktags/gcov">gcov</a>, 
    
    <a href="http://unlogic.co.uktags/programming">programming</a>
    

</span>
</footer>

            
            <p>Recently I setup a project that uses CMake as its build tool and <a href="https://code.google.com/p/googletest/">googletest</a> as a unit test framework. As is common place I wanted to make sure that my tests cover as much of the code as possible, so I went and grabbed the trusty gcov/lcov to analyse the tests only to find it wasn&rsquo;t as easy as I expected. I should mention this is the first time I have used CMake aswell as googletest. Granted, googletest is fairly simple and doesn&rsquo;t really complicate things when it comes to getting code coverage. I just had to figure out how we get CMake to build the test runner properly and then how to invoke lcov correctly. Turns out this was fairly easy too, once you ironed out some of the trickier bits and learned a little more about CMake.</p>

<p>In the <code>CMakeLists.txt</code> file for your test suite you need to add the following (I&rsquo;ve omitted some lines that aren&rsquo;t relevant to this article):</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #f8f8f2">SET(</span><span style="color: #e6db74">PROJECT_TEST_NAME</span> <span style="color: #f92672">${</span><span style="color: #f8f8f2">PROJECT_NAME_STR</span><span style="color: #f92672">}</span><span style="color: #e6db74">_test</span><span style="color: #f8f8f2">)</span>
    
<span style="color: #f8f8f2">SET(</span><span style="color: #e6db74">CMAKE_CXX_FLAGS</span> <span style="color: #e6db74">&quot;-g -O0 -Wall -fprofile-arcs -ftest-coverage&quot;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">SET(</span><span style="color: #e6db74">CMAKE_C_FLAGS</span> <span style="color: #e6db74">&quot;-g -O0 -Wall -W -fprofile-arcs -ftest-coverage&quot;</span><span style="color: #f8f8f2">)</span>
<span style="color: #f8f8f2">SET(</span><span style="color: #e6db74">CMAKE_EXE_LINKER_FLAGS</span> <span style="color: #e6db74">&quot;-fprofile-arcs -ftest-coverage&quot;</span><span style="color: #f8f8f2">)</span>

<span style="color: #960050; background-color: #1e0010">.</span>   
<span style="color: #960050; background-color: #1e0010">.</span>
<span style="color: #960050; background-color: #1e0010">.</span>

<span style="color: #f8f8f2">target_link_libraries(</span><span style="color: #f92672">${</span><span style="color: #f8f8f2">PROJECT_TEST_NAME</span><span style="color: #f92672">}</span> <span style="color: #e6db74">&quot;gtest_main&quot;</span> <span style="color: #e6db74">&quot;gtest&quot;</span> <span style="color: #e6db74">&quot;pthread&quot;</span><span style="color: #f8f8f2">)</span>
</pre></div>


<p>We need to make sure a debug build is on (<code>-g</code>), that we build without optimisation (<code>-O0</code>), and enable profiling (<code>-fprofile-arcs -ftest-coverage</code>). On the link phase we need to link against the google unit test libraries and pthread. Once you have sucessfully built your unit test you can then use lcov to generate the coverage results. Although you&rsquo;ll soon notice that it might not work. CMake places its files into different directories than you&rsquo;d expect from make or other build systems. So here&rsquo;s what I did to get this to work. Assuming you have a <code>tests</code> directory in your build, where your tests are and the test runner binary is built into, you have to run the following from that directory (<code>${PROJECTDIR}/build/tests</code>):</p>

<p><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span style="color: #f8f8f2">$ </span>lcov --zerocounters --directory .
<span style="color: #f8f8f2">$ </span>lcov --capture --initial --directory . --output-file app

<span style="color: #75715e"># Now run your test app in the same directory</span>

<span style="color: #f8f8f2">$ </span>lcov --no-checksum --directory . --capture --output-file app.info
<span style="color: #f8f8f2">$ </span>genthml app.info
</pre></div>
</p>

<p>Now you can point your browser to that directory and you will have the nice html view of your coverage data.</p>

<p><em>Note</em>: sometimes I got an error from the second to last line saying it could not find any gcno files. In this case I just ran the test runner again and then ran the last two lines from above again.</p>

<p>Hope this helps you out in case you have the same issue as me.</p>

            <ul class="share-buttons">
    <li></li>
    <li>
        <a class="icon-facebook-squared" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2funlogic.co.uk%2f2012%2f08%2f13%2fcmake-and-gcov%2f" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-twitter" href="https://twitter.com/share?text=cmake%20and%20gcov&amp;url=http%3a%2f%2funlogic.co.uk%2f2012%2f08%2f13%2fcmake-and-gcov%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-gplus" href="https://plus.google.com/share?url=http%3a%2f%2funlogic.co.uk%2f2012%2f08%2f13%2fcmake-and-gcov%2f" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" title=""></a>
    </li>
    <li>
        <a class="icon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2funlogic.co.uk%2f2012%2f08%2f13%2fcmake-and-gcov%2f&title=cmake%20and%20gcov" onclick="window.open(this.href, 'linkedin-share', 'width=600,height=494');return false;" title=""></a>
    </li>
</ul>

        </article>
        <div class="comments">
            <h3></h3>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'unlogic';
    var disqus_identifier = 'http:\/\/unlogic.co.uk\/2012\/08\/13\/cmake-and-gcov\/';
    var disqus_title = 'cmake and gcov';
    var disqus_url = 'http:\/\/unlogic.co.uk\/2012\/08\/13\/cmake-and-gcov\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </main>
    <aside class="author">
  <img class="profile-image" src="http://unlogic.co.ukimages/avatar.jpg" alt="Sven Steinbauer" />
  <p class="name"> 
  <strong>Sven Steinbauer</strong></p>
  <p class="address"></p>
  <p class="link"></p>
  <ul class="social">
    
<li><a href="//twitter.com/binaryheadache" class="icon-twitter" target="_blank" title="Twitter"></a></li>













<li><a href="//github.com/svenito" class="icon-github" target="_blank" title="Github"></a></li>




<li><a href="http://unlogic.co.ukpost/index.xml" class="icon-rss" target="_blank" title="RSS"></a></li>

  </ul>
  <br><br>
</aside>

</div>

<footer class="main-footer">
  <div class="container clearfix">
        <a class="icon-rss" href="http://unlogic.co.ukpost/index.xml" title="RSS"></a>
        <p>&copy; 2016 &middot; Sven Steinbauer</p>
  </div>
</footer>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>window.jQuery || document.write('<script src="http:\/\/unlogic.co.ukjs/vendor/jquery-1.11.0.min.js"><\/script>')</script>
<script src="http://unlogic.co.ukjs/plugins.js"></script>

</body>
</html>

