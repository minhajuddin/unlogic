<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>cmake and gcov - Unlogic</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <link rel="canonical" href="http://unlogic.co.uk/2012/08/13/cmake-and-gcov/">

  
  

  
  

  
  

  <link rel="stylesheet" type="text/css" href="http://unlogic.co.uk//css/combined-min.css">

</head>
<body class="">

<div class="site-wrap">
  <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="http://unlogic.co.uk/" class="site-title">Unlogic</a>
      <nav class="site-nav right">
      <a href="http://unlogic.co.uk/about/">About</a>
<a href="http://unlogic.co.uk/tags">Tags</a>
<a href="http://unlogic.co.uk/contact/">Contact</a>

</form>

      </nav>
      <div class="clearfix"></div>
    </div>
  </div>
</header>

  <div class="post p2 p-responsive wrap" role="main">
    <div class="measure">
      <div class="post-header mb2">
        <h1 class="py2">cmake and gcov</h1>
        <span class="post-meta">Aug 13, 2012 by </span><br>
        
      </div>

      <article class="post-content">
      <p>Recently I setup a project that uses CMake as its build tool and <a href="https://code.google.com/p/googletest/">googletest</a> as a unit test framework. As is common place I wanted to make sure that my tests cover as much of the code as possible, so I went and grabbed the trusty gcov/lcov to analyse the tests only to find it wasn&rsquo;t as easy as I expected. I should mention this is the first time I have used CMake aswell as googletest. Granted, googletest is fairly simple and doesn&rsquo;t really complicate things when it comes to getting code coverage. I just had to figure out how we get CMake to build the test runner properly and then how to invoke lcov correctly. Turns out this was fairly easy too, once you ironed out some of the trickier bits and learned a little more about CMake.</p>

<p>In the <code>CMakeLists.txt</code> file for your test suite you need to add the following (I&rsquo;ve omitted some lines that aren&rsquo;t relevant to this article):</p>

<div class="highlight"><pre><code class="language-cmake" data-lang="cmake"><span class="nb">SET</span><span class="p">(</span><span class="s">PROJECT_TEST_NAME</span> <span class="o">${</span><span class="nv">PROJECT_NAME_STR</span><span class="o">}</span><span class="s">_test</span><span class="p">)</span>
    
<span class="nb">SET</span><span class="p">(</span><span class="s">CMAKE_CXX_FLAGS</span> <span class="s2">&quot;-g -O0 -Wall -fprofile-arcs -ftest-coverage&quot;</span><span class="p">)</span>
<span class="nb">SET</span><span class="p">(</span><span class="s">CMAKE_C_FLAGS</span> <span class="s2">&quot;-g -O0 -Wall -W -fprofile-arcs -ftest-coverage&quot;</span><span class="p">)</span>
<span class="nb">SET</span><span class="p">(</span><span class="s">CMAKE_EXE_LINKER_FLAGS</span> <span class="s2">&quot;-fprofile-arcs -ftest-coverage&quot;</span><span class="p">)</span>

<span class="err">.</span>   
<span class="err">.</span>
<span class="err">.</span>

<span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_TEST_NAME</span><span class="o">}</span> <span class="s2">&quot;gtest_main&quot;</span> <span class="s2">&quot;gtest&quot;</span> <span class="s2">&quot;pthread&quot;</span><span class="p">)</span>
</code></pre></div>


<p>We need to make sure a debug build is on (<code>-g</code>), that we build without optimisation (<code>-O0</code>), and enable profiling (<code>-fprofile-arcs -ftest-coverage</code>). On the link phase we need to link against the google unit test libraries and pthread. Once you have sucessfully built your unit test you can then use lcov to generate the coverage results. Although you&rsquo;ll soon notice that it might not work. CMake places its files into different directories than you&rsquo;d expect from make or other build systems. So here&rsquo;s what I did to get this to work. Assuming you have a <code>tests</code> directory in your build, where your tests are and the test runner binary is built into, you have to run the following from that directory (<code>${PROJECTDIR}/build/tests</code>):</p>

<p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>lcov --zerocounters --directory .
<span class="nv">$ </span>lcov --capture --initial --directory . --output-file app

<span class="c"># Now run your test app in the same directory</span>

<span class="nv">$ </span>lcov --no-checksum --directory . --capture --output-file app.info
<span class="nv">$ </span>genthml app.info
</code></pre></div>
</p>

<p>Now you can point your browser to that directory and you will have the nice html view of your coverage data.</p>

<p><em>Note</em>: sometimes I got an error from the second to last line saying it could not find any gcno files. In this case I just ran the test runner again and then ran the last two lines from above again.</p>

<p>Hope this helps you out in case you have the same issue as me.</p>

      </article>

      <p class="post-meta">Tags:&nbsp;
        
            
            <a href="http://unlogic.co.uk//tags/cmake">cmake</a>
        
            ,&nbsp;
            <a href="http://unlogic.co.uk//tags/gcov">gcov</a>
        
            ,&nbsp;
            <a href="http://unlogic.co.uk//tags/programming">programming</a>
        
      </p>

      
<div id="disqus_thread">
  <script type="text/javascript">
     var disqus_shortname = "unlogic";
     var disqus_identifier = "\/2012\/08\/13\/cmake-and-gcov\/";

     (function() {
       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
       dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
</div>


    </div>
  </div>
</div>
    <footer class="footer">
      <div class="p2 wrap">
        <div class="measure mt1 center">
      <nav class="social-icons icons">
<a class="fa fa-rss rss" href="http://unlogic.co.uk/index.xml"></a>

<a class="fa fa-twitter twitter" href="https://twitter.com/binaryheadache"></a>

</nav>

          <small>
            Copyright &#169; 2015<br>
            Powered by <a href="http://gohugo.io/" target="_blank">Hugo</a> &amp; <a href="https://github.com/azmelanar/hugo-theme-pixyll" target="_blank">Pixyll</a>
          </small>
        </div>
      </div>
    </footer>

    
    <script src="http://unlogic.co.uk/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    


</body>
</html>

